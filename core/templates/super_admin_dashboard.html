{% extends 'base.html' %}
{% load static %}
{% load core_filters %}

{% block title %}System Administration — CedCast{% endblock %}

{% block content %}
{% include "super_admin_combined_nav.html" %}

<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0">System Administration Dashboard</h1>
      <p class="text-muted mb-0">Welcome back, {{ request.user.username }}</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'enroll_tenant' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1"></i>Enroll Organization
      </a>
      <a href="{% url 'super_orgs' %}" class="btn btn-outline-secondary">
        <i class="bi bi-building me-1"></i>Manage Organizations
      </a>
    </div>
  </div>

  <!-- CSRF Token for AJAX requests -->
  {% csrf_token %}

  <!-- Alert for dry-run mode -->
  {% if hubtel_dry_run or clicksend_dry_run %}
  <div class="alert alert-warning">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Test Mode Active:</strong>
    {% if hubtel_dry_run %}Hubtel{% endif %}
    {% if clicksend_dry_run %}{% if hubtel_dry_run %} & {% endif %}ClickSend{% endif %}
    are running in dry-run mode — outgoing messages are simulated.
  </div>
  {% endif %}

  <!-- Key Metrics -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-primary mb-2">
            <i class="bi bi-building fs-1"></i>
          </div>
          <h2 class="h4 mb-1">{{ total_orgs|default:0 }}</h2>
          <p class="text-muted mb-0">Active Organizations</p>
          {% if active_orgs_recent %}
          <small class="text-success">
            <i class="bi bi-arrow-up"></i> {{ active_orgs_recent }} active this month
          </small>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-success mb-2">
            <i class="bi bi-chat-dots fs-1"></i>
          </div>
          <h2 class="h4 mb-1">{{ total_sms_sent_all|default:0|format_number }}</h2>
          <p class="text-muted mb-0">Total SMS Sent</p>
          {% if recent_sms %}
          <small class="text-success">
            <i class="bi bi-arrow-up"></i> {{ recent_sms|format_number }} this month
          </small>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-warning mb-2">
            <i class="bi bi-cash fs-1"></i>
          </div>
          <h2 class="h4 mb-1">₵{{ total_balance_all|default:0|floatformat:0|format_number }}</h2>
          <p class="text-muted mb-0">Total Balance</p>
          {% if total_revenue %}
          <small class="text-success">
            <i class="bi bi-arrow-up"></i> ₵{{ total_revenue|floatformat:0|format_number }} revenue
          </small>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-info mb-2">
            <i class="bi bi-person-plus fs-1"></i>
          </div>
          <h2 class="h4 mb-1">{{ pending_enrollment_requests|length }}</h2>
          <p class="text-muted mb-0">Pending Reviews</p>
          {% if approved_enrollment_requests %}
          <small class="text-success">
            <i class="bi bi-check-circle"></i> {{ approved_enrollment_requests|length }} ready for setup
          </small>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Section -->
  <div class="row mb-4">
    <div class="col-lg-8 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-graph-up me-2"></i>30-Day Trends
          </h5>
        </div>
        <div class="card-body">
          <canvas id="trendsChart" height="200"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Performance Summary</h5>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <i class="bi bi-chat-dots-fill text-success fs-5 me-3"></i>
            <div>
              <div class="fw-bold">SMS Delivery Rate</div>
              <small class="text-muted">{{ avg_delivery_rate|floatformat:1 }}% average</small>
            </div>
          </div>
          <div class="d-flex align-items-center mb-3">
            <i class="bi bi-building-fill text-primary fs-5 me-3"></i>
            <div>
              <div class="fw-bold">Organization Growth</div>
              <small class="text-muted">{{ total_orgs_this_week }} new this week</small>
            </div>
          </div>
          <div class="d-flex align-items-center">
            <i class="bi bi-cash-fill text-warning fs-5 me-3"></i>
            <div>
              <div class="fw-bold">Revenue</div>
              <small class="text-muted">{{ total_payments_this_week }} payments this week</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enrollment Management -->
  {% if pending_enrollment_requests or approved_enrollment_requests %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-people-fill me-2"></i>Enrollment Management
          </h5>
          <div class="d-flex gap-2">
            {% if pending_enrollment_requests %}
            <span class="badge bg-warning">{{ pending_enrollment_requests|length }} Pending</span>
            {% endif %}
            {% if approved_enrollment_requests %}
            <span class="badge bg-success">{{ approved_enrollment_requests|length }} Ready</span>
            {% endif %}
          </div>
        </div>
        <div class="card-body">

          <!-- Pending Requests -->
          {% if pending_enrollment_requests %}
          <div class="mb-4">
            <h6 class="text-warning mb-3">
              <i class="bi bi-exclamation-triangle me-2"></i>Requires Review
            </h6>
            <div class="row g-3">
              {% for request in pending_enrollment_requests %}
              <div class="col-md-6 col-lg-4">
                <div class="card border-warning">
                  <div class="card-body">
                    <h6 class="card-title">{{ request.org_name|truncatechars:25 }}</h6>
                    <div class="small text-muted mb-2">
                      <div><i class="bi bi-person me-1"></i>{{ request.contact_name }}</div>
                      <div><i class="bi bi-envelope me-1"></i>{{ request.email|truncatechars:25 }}</div>
                      <div><i class="bi bi-calendar me-1"></i>{{ request.created_at|date:"M d, Y" }}</div>
                    </div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-success btn-sm" onclick="approveRequest({{ request.id }}, event)">
                        <i class="bi bi-check-circle me-1"></i>Approve
                      </button>
                      <button class="btn btn-danger btn-sm" onclick="rejectRequest({{ request.id }})">
                        <i class="bi bi-x-circle me-1"></i>Reject
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" onclick="viewRequestDetails({{ request.id }})">
                        <i class="bi bi-eye me-1"></i>View
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Approved Requests Ready for Setup -->
          {% if approved_enrollment_requests %}
          <div>
            <h6 class="text-success mb-3">
              <i class="bi bi-check-circle me-2"></i>Ready for Account Creation
            </h6>
            <div class="row g-3">
              {% for request in approved_enrollment_requests %}
              <div class="col-md-6 col-lg-4">
                <div class="card border-success">
                  <div class="card-body">
                    <h6 class="card-title">{{ request.org_name|truncatechars:25 }}</h6>
                    <div class="small text-muted mb-2">
                      <div><i class="bi bi-person me-1"></i>{{ request.contact_name }}</div>
                      <div><i class="bi bi-envelope me-1"></i>{{ request.email|truncatechars:25 }}</div>
                      <div><i class="bi bi-calendar me-1"></i>{{ request.reviewed_at|date:"M d, Y" }}</div>
                    </div>
                    <div class="d-flex gap-2">
                      <a href="{% url 'enroll_tenant' %}?prefill={{ request.id }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Create Account
                      </a>
                      <button class="btn btn-danger btn-sm" onclick="declineApprovedRequest({{ request.id }})">
                        <i class="bi bi-x-circle me-1"></i>Decline
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Recent Activity & Quick Access -->
  <div class="row mb-4">
    <!-- Recent Payments -->
    {% if recent_payment_transactions %}
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-cash me-2"></i>Recent Payments
          </h5>
          <a href="{% url 'super_payments' %}" class="btn btn-sm btn-outline-primary">
            View All
          </a>
        </div>
        <div class="card-body">
          {% for payment in recent_payment_transactions %}
          <div class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom">
            <div class="d-flex align-items-center">
              <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 fw-bold" style="width: 40px; height: 40px;">
                {{ payment.organization.name|slice:":1"|upper }}
              </div>
              <div>
                <div class="fw-bold">{{ payment.organization.name|truncatechars:20 }}</div>
                <small class="text-muted">{{ payment.created_at|date:"M d, H:i" }}</small>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-bold text-success">₵{{ payment.amount|floatformat:2 }}</div>
              <small class="badge bg-success">{{ payment.status|title }}</small>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Quick Access Panel -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-grid me-2"></i>Quick Access
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <a href="{% url 'super_orgs' %}" class="card h-100 text-center text-decoration-none border-primary">
                <div class="card-body">
                  <i class="bi bi-building fs-2 text-primary mb-2"></i>
                  <div class="fw-bold text-primary">Organizations</div>
                </div>
              </a>
            </div>
            <div class="col-6">
              <a href="{% url 'global_templates' %}" class="card h-100 text-center text-decoration-none border-success">
                <div class="card-body">
                  <i class="bi bi-file-earmark-text fs-2 text-success mb-2"></i>
                  <div class="fw-bold text-success">Templates</div>
                </div>
              </a>
            </div>
            <div class="col-6">
              <a href="{% url 'system_logs' %}" class="card h-100 text-center text-decoration-none border-warning">
                <div class="card-body">
                  <i class="bi bi-journal-text fs-2 text-warning mb-2"></i>
                  <div class="fw-bold text-warning">System Logs</div>
                </div>
              </a>
            </div>
            <div class="col-6">
              <a href="{% url 'audit_message_logs' %}" class="card h-100 text-center text-decoration-none border-danger">
                <div class="card-body">
                  <i class="bi bi-shield-check fs-2 text-danger mb-2"></i>
                  <div class="fw-bold text-danger">Audit Logs</div>
                </div>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- JavaScript for enrollment actions and charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let trendsChart = null;

// Initialize trends chart
function initTrendsChart() {
  const ctx = document.getElementById('trendsChart');
  if (!ctx) return;

  const messagesData = {{ messages_trend|safe }};
  const orgsData = {{ orgs_trend|safe }};
  const deliveryData = {{ delivery_trend|safe }};

  // Generate labels for last 30 days
  const labels = [];
  for (let i = 29; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
  }

  trendsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'SMS Sent',
        data: messagesData,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        tension: 0.4,
        fill: true
      }, {
        label: 'New Organizations',
        data: orgsData,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: 'rgba(255, 255, 255, 0.8)'
          }
        }
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          },
          ticks: {
            color: 'rgba(255, 255, 255, 0.7)'
          }
        },
        y: {
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          },
          ticks: {
            color: 'rgba(255, 255, 255, 0.7)'
          }
        }
      }
    }
  });
}

function refreshTrends() {
  // Add loading state
  const refreshBtn = document.querySelector('button[onclick="refreshTrends()"]');
  const originalText = refreshBtn.innerHTML;
  refreshBtn.disabled = true;
  refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise bi-spin me-1"></i>Refreshing...';

  // Simulate refresh (in real implementation, this would fetch new data)
  setTimeout(() => {
    // Reinitialize chart with potentially new data
    if (trendsChart) {
      trendsChart.destroy();
    }
    initTrendsChart();

    // Reset button
    refreshBtn.disabled = false;
    refreshBtn.innerHTML = originalText;

    showToast('Trends updated successfully!', 'success');
  }, 1500);
}

// Add fade-in animations on page load
document.addEventListener('DOMContentLoaded', function() {
  // Initialize chart
  initTrendsChart();

  // Animate metric cards
  const metricCards = document.querySelectorAll('.metric-card-modern');
  metricCards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    setTimeout(() => {
      card.style.transition = 'all 0.6s ease';
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, index * 100);
  });

  // Animate action cards
  const actionCards = document.querySelectorAll('.card');
  actionCards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    setTimeout(() => {
      card.style.transition = 'all 0.6s ease';
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, (index * 100) + 400);
  });

  // Add hover effects for table rows
  const tableRows = document.querySelectorAll('.table-row-hover');
  tableRows.forEach(row => {
    row.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.01)';
    });
    row.addEventListener('mouseleave', function() {
      this.style.transform = 'scale(1)';
    });
  });

  // Add click ripple effect for buttons
  const buttons = document.querySelectorAll('.btn, .card');
  buttons.forEach(button => {
    button.addEventListener('click', function(e) {
      const ripple = document.createElement('div');
      ripple.style.position = 'absolute';
      ripple.style.borderRadius = '50%';
      ripple.style.background = 'rgba(255, 255, 255, 0.3)';
      ripple.style.transform = 'scale(0)';
      ripple.style.animation = 'ripple 0.6s linear';
      ripple.style.left = (e.offsetX - 10) + 'px';
      ripple.style.top = (e.offsetY - 10) + 'px';
      ripple.style.width = '20px';
      ripple.style.height = '20px';

      this.style.position = 'relative';
      this.style.overflow = 'hidden';
      this.appendChild(ripple);

      setTimeout(() => {
        ripple.remove();
      }, 600);
    });
  });
});

// Add ripple animation
const style = document.createElement('style');
style.textContent = `
  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }
  .bi-spin {
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

              <div class="action-icon mb-3">
                <i class="bi bi-journal-text fs-2 text-secondary"></i>
              </div>
              <h5 class="fw-bold mb-2">System Logs</h5>
              <p class="small text-muted mb-0">Monitor system activity</p>
            </a>
          </div>
          <div class="col-md-6 col-lg-3">
            <a href="{% url 'audit_message_logs' %}" class="card h-100 text-center text-decoration-none border-danger">
              <div class="card-body">
                <i class="bi bi-shield-check fs-2 text-danger mb-3"></i>
                <h5 class="card-title">Audit Message Logs</h5>
                <p class="small text-muted mb-0">Complete message audit trail</p>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="row g-4">
    <!-- Recent Organizations -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <i class="bi bi-building-fill fs-4 me-3"></i>
              <h5 class="mb-0 fw-bold">Recent Organizations</h5>
            </div>
            <a href="{% url 'super_orgs' %}" class="btn btn-light btn-sm">
              View All <i class="bi bi-arrow-right ms-1"></i>
            </a>
          </div>
        </div>
        <div class="card-body">

        {% if orgs|length > 0 %}
        <div class="table-responsive">
          <table class="table table-hover-modern">
            <thead>
              <tr>
                <th class="border-0 fw-bold text-white">Organization</th>
                <th class="border-0 fw-bold text-white">Type</th>
                <th class="border-0 fw-bold text-white">SMS Sent</th>
                <th class="border-0 fw-bold text-white">Balance</th>
                <th class="border-0 fw-bold text-white">Status</th>
                <th class="border-0 fw-bold text-white">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for org in orgs|slice:":8" %}
              <tr class="table-row-hover">
                <td class="border-0">
                  <div class="d-flex align-items-center">
                    <div class="org-avatar rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center me-3 fw-bold">
                      {{ org.name|slice:":1"|upper }}
                    </div>
                    <div>
                      <div class="fw-bold text-white">{{ org.name }}</div>
                      <small class="text-white-50">{{ org.slug }}</small>
                    </div>
                  </div>
                </td>
                <td class="border-0">
                  <span class="badge-modern bg-primary">{{ org.get_org_type_display }}</span>
                </td>
                <td class="border-0 fw-semibold text-white">{{ org.total_sms_sent|format_number }}</td>
                <td class="border-0 fw-semibold text-white">₵{{ org.balance|floatformat:2 }}</td>
                <td class="border-0">
                  {% if org.is_active %}
                    <span class="badge-modern bg-success">
                      <i class="bi bi-check-circle-fill me-1"></i>Active
                    </span>
                  {% else %}
                    <span class="badge-modern bg-danger">
                      <i class="bi bi-x-circle-fill me-1"></i>Suspended
                    </span>
                  {% endif %}
                </td>
                <td class="border-0">
                  <a href="{% url 'super_edit_org' org.slug %}" class="btn btn-sm btn-outline-primary rounded-pill">
                    <i class="bi bi-pencil-fill"></i>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if orgs|length > 8 %}
        <div class="text-center mt-4">
          <a href="{% url 'super_orgs' %}" class="btn btn-light btn-lg px-4">
            <i class="bi bi-building me-2"></i>
            View All Organizations ({{ orgs|length }})
          </a>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-5">
          <div class="empty-state-icon mb-4">
            <i class="bi bi-building display-1 text-white-50"></i>
          </div>
          <h4 class="text-white-50 mb-3">No Organizations Yet</h4>
          <p class="text-muted mb-4">Start building your SMS network by enrolling your first organization.</p>
          <a href="{% url 'enroll_tenant' %}" class="btn btn-primary btn-lg px-4">
            <i class="bi bi-plus-circle-fill me-2"></i>Enroll First Organization
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- System Status & Analytics -->
    <div class="col-lg-4">
      <div class="d-flex flex-column gap-4 h-100">
        <!-- System Status -->
        <div class="card">
          <div class="card-header bg-info text-white">
            <div class="d-flex align-items-center">
              <i class="bi bi-info-circle-fill fs-4 me-3"></i>
              <h6 class="mb-0 fw-bold">System Status</h6>
            </div>
          </div>
          <div class="card-body">
            <div class="d-flex align-items-center mb-3 p-2 border rounded">
              <div class="me-3">
                <i class="bi bi-check-circle-fill text-success fs-4"></i>
              </div>
              <div class="flex-grow-1">
                <div class="fw-bold text-success">System Health</div>
                <small class="text-muted">All services operational</small>
              </div>
            </div>
          </div>

            <div class="d-flex align-items-center mb-3 p-2 border rounded">
              <div class="me-3">
                <i class="bi bi-database-fill text-primary fs-4"></i>
              </div>
              <div class="flex-grow-1">
                <div class="fw-bold text-primary">Database</div>
                <small class="text-muted">Connected and responsive</small>
              </div>
            </div>

            <div class="d-flex align-items-center p-2 border rounded {% if hubtel_dry_run or clicksend_dry_run %}border-warning{% else %}border-success{% endif %}">
              <div class="me-3">
                {% if hubtel_dry_run or clicksend_dry_run %}
                  <i class="bi bi-exclamation-triangle-fill text-warning fs-4"></i>
                {% else %}
                  <i class="bi bi-chat-dots-fill text-success fs-4"></i>
                {% endif %}
              </div>
              <div class="flex-grow-1">
                <div class="fw-bold {% if hubtel_dry_run or clicksend_dry_run %}text-warning{% else %}text-success{% endif %}">SMS Providers</div>
              <small class="text-white-50">
                {% if hubtel_dry_run or clicksend_dry_run %}
                  Test mode active
                {% else %}
                  Live messaging enabled
                {% endif %}
              </small>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
          <div class="card-header bg-success text-white">
            <div class="d-flex align-items-center">
              <i class="bi bi-bar-chart-fill fs-4 me-3"></i>
              <h6 class="mb-0 fw-bold">Quick Stats</h6>
            </div>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
              <span class="text-muted">This Week</span>
              <span class="fw-bold text-success">+{{ recent_sms|default:0|format_number }}</span>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
              <span class="text-muted">Active Orgs</span>
            <span class="fw-bold text-primary">{{ active_orgs_recent|default:0 }}</span>
          </div>

            <div class="d-flex justify-content-between align-items-center">
              <span class="text-muted">Avg Response</span>
              <span class="fw-bold text-info">< 2s</span>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Add fade-in animations on page load
document.addEventListener('DOMContentLoaded', function() {
  // Animate metric cards
  const metricCards = document.querySelectorAll('.metric-card-modern');
  metricCards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    setTimeout(() => {
      card.style.transition = 'all 0.6s ease';
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, index * 100);
  });

  // Animate action cards
  const actionCards = document.querySelectorAll('.card');
  actionCards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    setTimeout(() => {
      card.style.transition = 'all 0.6s ease';
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, (index * 100) + 400);
  });

  // Add hover effects for table rows
  const tableRows = document.querySelectorAll('.table-row-hover');
  tableRows.forEach(row => {
    row.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.01)';
    });
    row.addEventListener('mouseleave', function() {
      this.style.transform = 'scale(1)';
    });
  });

  // Add click ripple effect for buttons
  const buttons = document.querySelectorAll('.btn, .card');
  buttons.forEach(button => {
    button.addEventListener('click', function(e) {
      const ripple = document.createElement('div');
      ripple.style.position = 'absolute';
      ripple.style.borderRadius = '50%';
      ripple.style.background = 'rgba(255, 255, 255, 0.3)';
      ripple.style.transform = 'scale(0)';
      ripple.style.animation = 'ripple 0.6s linear';
      ripple.style.left = (e.offsetX - 10) + 'px';
      ripple.style.top = (e.offsetY - 10) + 'px';
      ripple.style.width = '20px';
      ripple.style.height = '20px';

      this.style.position = 'relative';
      this.style.overflow = 'hidden';
      this.appendChild(ripple);

      setTimeout(() => {
        ripple.remove();
      }, 600);
    });
  });
});

// Add ripple animation
const style = document.createElement('style');
style.textContent = `
  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

// Enrollment request management functions
function approveRequest(requestId, event) {
  if (confirm('Are you sure you want to approve this enrollment request?')) {
    fetch(`/super/approve-enrollment/${requestId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('Enrollment request approved successfully!', 'success');
        
        // Animate the card before reload
        const requestCard = event.target.closest('.card');
        if (requestCard) {
          requestCard.style.transition = 'all 0.3s ease';
          requestCard.style.opacity = '0';
          requestCard.style.transform = 'scale(0.95)';
          setTimeout(() => location.reload(), 300);
        } else {
          setTimeout(() => location.reload(), 1000);
        }
      } else {
        showToast('Error: ' + (data.error || 'Unknown error occurred'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while processing the request.');
    });
  }
}

function rejectRequest(requestId) {
  // Store the request ID for the modal submission
  window.currentRejectRequestId = requestId;

  // Clear previous reason
  document.getElementById('rejectionReason').value = '';

  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
  modal.show();
}

function submitRejection() {
  const requestId = window.currentRejectRequestId;
  const reason = document.getElementById('rejectionReason').value.trim();

  if (!reason) {
    alert('Please provide a rejection reason.');
    return;
  }

  // Disable button to prevent double submission
  const btn = document.getElementById('confirmRejectBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rejecting...';

  fetch(`/super/reject-enrollment/${requestId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: new URLSearchParams({ reason: reason })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Hide modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
      modal.hide();

      // Show success toast
      showToast('Enrollment request rejected successfully!', 'success');
      
      // Remove the request card with animation
      const requestCard = document.querySelector(`[data-request-id="${requestId}"]`);
      if (requestCard) {
        requestCard.style.transition = 'all 0.3s ease';
        requestCard.style.opacity = '0';
        requestCard.style.transform = 'scale(0.95)';
        setTimeout(() => {
          requestCard.remove();
          location.reload(); // Reload to update counts
        }, 300);
      } else {
        setTimeout(() => location.reload(), 1000);
      }
    } else {
      showToast('Error: ' + (data.error || 'Unknown error occurred'), 'error');
      // Re-enable button
      btn.disabled = false;
      btn.innerHTML = 'Reject Request';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred while processing the request.');
    // Re-enable button
    btn.disabled = false;
    btn.innerHTML = 'Reject Request';
  });
}

// Function to decline an already approved request
function declineApprovedRequest(requestId) {
  // Store the request ID for the modal submission
  window.currentRejectRequestId = requestId;

  // Clear previous reason
  document.getElementById('rejectionReason').value = '';

  // Update modal title to reflect this is declining an approved request
  document.getElementById('rejectModalLabel').textContent = 'Decline Approved Enrollment Request';

  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
  modal.show();
}

// Add event listener for the reject button
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('confirmRejectBtn').addEventListener('click', submitRejection);
  
  // Initialize tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

// Enrollment request management functions
function viewRequestDetails(requestId) {
    // For now, just redirect to enroll page with prefill
    // In future, could show a modal with full details
    window.location.href = `/super/enroll/?prefill=${requestId}`;
}

function rejectRequest(requestId) {
  // Store the request ID for the modal submission
  window.currentRejectRequestId = requestId;

  // Clear previous reason
  document.getElementById('rejectionReason').value = '';

  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
  modal.show();
}

function submitRejection() {
  const requestId = window.currentRejectRequestId;
  const reason = document.getElementById('rejectionReason').value.trim();

  if (!reason) {
    alert('Please provide a rejection reason.');
    return;
  }

  // Disable button to prevent double submission
  const btn = document.getElementById('confirmRejectBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rejecting...';

  fetch(`/super/reject-enrollment/${requestId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: new URLSearchParams({ reason: reason })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Hide modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
      modal.hide();

      // Show success toast
      showToast('Enrollment request rejected successfully!', 'success');

      // Remove the request card with animation
      const requestCard = document.querySelector(`[data-request-id="${requestId}"]`);
      if (requestCard) {
        requestCard.style.transition = 'all 0.3s ease';
        requestCard.style.opacity = '0';
        requestCard.style.transform = 'scale(0.95)';
        setTimeout(() => {
          requestCard.remove();
          location.reload(); // Reload to update counts
        }, 300);
      } else {
        setTimeout(() => location.reload(), 1000);
      }
    } else {
      showToast('Error: ' + (data.error || 'Unknown error occurred'), 'error');
      // Re-enable button
      btn.disabled = false;
      btn.innerHTML = 'Reject Request';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred while processing the request.');
    // Re-enable button
    btn.disabled = false;
    btn.innerHTML = 'Reject Request';
  });
}

// Function to decline an already approved request
function declineApprovedRequest(requestId) {
  // Store the request ID for the modal submission
  window.currentRejectRequestId = requestId;

  // Clear previous reason
  document.getElementById('rejectionReason').value = '';

  // Update modal title to reflect this is declining an approved request
  document.getElementById('rejectModalLabel').textContent = 'Decline Approved Enrollment Request';

  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
  modal.show();
}

// Add event listener for the reject button
document.addEventListener('DOMContentLoaded', function() {
  const confirmRejectBtn = document.getElementById('confirmRejectBtn');
  if (confirmRejectBtn) {
    confirmRejectBtn.addEventListener('click', submitRejection);
  }

  // Initialize tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

// Toast notification function
function showToast(message, type = 'info') {
  // Remove existing toasts
  const existingToasts = document.querySelectorAll('.toast-notification');
  existingToasts.forEach(toast => toast.remove());

  // Create toast element
  const toast = document.createElement('div');
  toast.className = `toast-notification alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
  toast.style.cssText = `
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideInRight 0.3s ease;
  `;
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
      <div>${message}</div>
      <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;

  document.body.appendChild(toast);

  // Auto remove after 5 seconds
  setTimeout(() => {
    if (toast.parentElement) {
      toast.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }
  }, 5000);
}

// Add toast animations
const toastStyles = document.createElement('style');
toastStyles.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(toastStyles);
</script>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectModalLabel">Reject Enrollment Request</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Please provide a reason for rejecting this enrollment request. This will be sent to the applicant via email.</p>
        <form id="rejectForm" onsubmit="return false;">
          <div class="mb-3">
            <label for="rejectionReason" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
            <textarea class="form-control" id="rejectionReason" rows="4" placeholder="Please explain why this enrollment request is being rejected..."></textarea>
            <div class="form-text">Be specific about requirements that weren't met or other issues.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmRejectBtn">Reject Request</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
