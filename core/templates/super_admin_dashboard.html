<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <title>CedCast SMS platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="{% static 'images/cedcast_logo.png' %}" alt="CedCast" style="height:36px; max-height:36px; object-fit:contain; display:inline-block; margin-right:8px;" onerror="this.style.display='none'">
                <span class="align-middle">CedCast SMS platform</span>
            </a>
                <div class="d-flex">
                    <a href="/logout/" class="btn btn-outline-light">Logout</a>
                </div>
            </div>
        </nav>

        <div class="container">
            {% if hubtel_dry_run or clicksend_dry_run %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-warning"> <strong>Test mode:</strong>
                        {% if hubtel_dry_run %} Hubtel is running in dry-run mode — outgoing messages are simulated.{% endif %}
                        {% if clicksend_dry_run %}{% if hubtel_dry_run %} {% endif %} {% if hubtel_dry_run %}<br>{% endif %} ClickSend is running in dry-run mode — outgoing messages are simulated.{% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            <div id="messages-section" class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">Enrolled Orgs &amp; Stats</h5>
                                <p class="mb-0 text-muted">Quick access to organizations and aggregated stats.</p>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{% url 'super_orgs' %}" class="btn btn-outline-primary">Enrolled Orgs <span class="badge bg-secondary">{{ org_stats|length }}</span></a>
                                <a href="{% url 'system_logs' %}" class="btn btn-outline-secondary">Stats</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-8 order-md-1">
                    <div class="card shadow">
                        <div class="card-header bg-secondary text-white">Quick Actions</div>
                        <div class="card-body">
                            <p class="mb-2">Create tenants, view stats, and manage organizations from this dashboard.</p>
                            <div class="dropdown mb-3">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="quickActionsMenu" data-bs-toggle="dropdown" aria-expanded="false">
                                    Quick Actions
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="quickActionsMenu">
                                    <li><a class="dropdown-item" href="{% url 'enroll_tenant' %}">Enroll Tenant</a></li>
                                    <li><a class="dropdown-item" href="{% url 'super_orgs' %}">Onboarding</a></li>
                                    <li><a class="dropdown-item" href="{% url 'global_templates' %}">Global Templates</a></li>
                                    <li><a class="dropdown-item" href="{% url 'system_logs' %}">System Logs</a></li>
                                </ul>
                            </div>
                            {% if notice %}
                                <div class="alert alert-success">{{ notice }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 order-md-2">
                    <div class="card shadow">
                        <div class="card-header bg-secondary text-white">Messages Overview</div>
                        <div class="card-body text-center">
                            <canvas id="messagesChart" width="150" height="150" data-total="{{ total_messages|default:0 }}" data-sent="{{ total_sent|default:0 }}" style="max-width:160px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Removed duplicate Enrolled Organizations & Stats table — use Enrolled Orgs button above to view details -->

            <!-- Enroll form removed from dashboard — use the dedicated Enroll page instead -->
        </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        (function(){
            const ctx = document.getElementById('messagesChart');
            const total = ctx ? parseInt(ctx.dataset.total || 0, 10) : 0;
            const sent = ctx ? parseInt(ctx.dataset.sent || 0, 10) : 0;
            const pending = Math.max(0, total - sent);
            if (ctx) {
                const chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Sent', 'Pending'],
                        datasets: [{
                            data: [sent, pending],
                            backgroundColor: ['#28a745', '#ffc107']
                        }]
                    },
                    options: {
                        plugins: { legend: { position: 'bottom' } },
                        onClick: (evt, elems) => {
                            if (!elems.length) return;
                            // Always jump to messages section for now
                            window.location.hash = '#messages-section';
                        }
                    }
                });
            }
        })();

        // Make table rows clickable when they have a data-href attribute.
        (function(){
            document.addEventListener('click', function(e){
                try {
                    // Find the nearest tr with data-href
                    const tr = e.target.closest && e.target.closest('tr[data-href]');
                    if (!tr) return;

                    // If the click was on an interactive element, don't hijack it
                    if (e.target.closest('a, button, input, textarea, select, label')) return;

                    const href = tr.getAttribute('data-href');
                    if (href) {
                        window.location.href = href;
                    }
                } catch (err) {
                    // swallow errors to avoid breaking the page
                    console.error('Row click handler error', err);
                }
            }, false);
        })();
    </script>
</body>
</html>