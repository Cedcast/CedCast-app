<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <title>CedCast SMS platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="{% static 'css/super_admin.css' %}" rel="stylesheet">
</head>
<body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'dashboard' %}">
                <img src="{% static 'images/cedcast_logo.png' %}" alt="CedCast" style="height:36px; max-height:36px; object-fit:contain; display:inline-block; margin-right:8px;" onerror="this.style.display='none'">
                <span class="align-middle">CedCast SMS platform</span>
            </a>
                <div class="d-flex">
                    <a href="/logout/" class="btn btn-outline-light">Logout</a>
                </div>
            </div>
        </nav>

        <div class="container">
            {% if hubtel_dry_run or clicksend_dry_run %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-warning"> <strong>Test mode:</strong>
                        {% if hubtel_dry_run %} Hubtel is running in dry-run mode — outgoing messages are simulated.{% endif %}
                        {% if clicksend_dry_run %}{% if hubtel_dry_run %} {% endif %} {% if hubtel_dry_run %}<br>{% endif %} ClickSend is running in dry-run mode — outgoing messages are simulated.{% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            <div id="messages-section" class="row mb-4">
                <div class="col-12">
                    <div class="card card-shadow">
                        <div class="card-body dashboard-header">
                            <div>
                                <h4 class="mb-1">Enrolled Orgs &amp; Stats</h4>
                                <div class="small-muted">Quick access to organizations and aggregated stats.</div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <a href="{% url 'super_orgs' %}" class="btn btn-outline-primary">
                                    <i class="bi bi-people" style="font-size:1rem; margin-right:6px"></i>
                                    Enrolled Orgs <span class="badge bg-secondary badge-org-count">{{ org_stats|length }}</span>
                                </a>
                                <a href="{% url 'system_logs' %}" class="btn btn-outline-secondary">Stats</a>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- Quick Onboard helper card -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card card-shadow">
                        <div class="card-body">
                            <div class="d-flex align-items-start justify-content-between">
                                <div>
                                    <h5 class="mb-1">Quick Onboard</h5>
                                    <div class="small-muted">Get an organization live in three simple steps.</div>
                                    <ol class="mt-2 mb-0" style="padding-left:18px">
                                        <li>Select <strong>New Tenant</strong> to create the organization and admin account.</li>
                                        <li>Open <strong>Onboarding</strong> to configure sender IDs and branding.</li>
                                        <li>Use <strong>Global Templates</strong> or create org templates to send messages.</li>
                                    </ol>
                                </div>
                                <div class="text-end">
                                    <a href="{% url 'enroll_tenant' %}" class="btn btn-primary btn-lg">Quick Onboard</a>
                                    <div class="mt-2"><a href="{% url 'system_logs' %}" class="small-muted">View onboarding docs</a></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-8 order-md-1">
                    <div class="card shadow">
                        <div class="card-header bg-secondary text-white">Quick Actions</div>
                        <div class="card-body">
                            <p class="mb-2">Create tenants, view stats, and manage organizations from this dashboard.</p>
                            <div class="d-flex gap-2 mb-3 align-items-start">
                                <div style="flex:1; min-width:220px">
                                    <!-- Quick Actions table (click rows to navigate) -->
                                    <table class="table table-sm table-hover quick-actions-table mb-0">
                                        <tbody>
                                            <tr data-href="{% url 'enroll_tenant' %}" tabindex="0" role="button" aria-label="Enroll Tenant">
                                                <td><i class="bi bi-person-plus-fill"></i></td>
                                                <td>Enroll Tenant</td>
                                                <td class="text-end"><small class="text-muted">Create a new tenant</small></td>
                                            </tr>
                                            <tr data-href="{% url 'super_orgs' %}" tabindex="0" role="button" aria-label="Onboarding">
                                                <td><i class="bi bi-building"></i></td>
                                                <td>Onboarding</td>
                                                <td class="text-end"><small class="text-muted">Manage organizations</small></td>
                                            </tr>
                                            <tr data-href="{% url 'global_templates' %}" tabindex="0" role="button" aria-label="Global Templates">
                                                <td><i class="bi bi-card-text"></i></td>
                                                <td>Global Templates</td>
                                                <td class="text-end"><small class="text-muted">Shared message templates</small></td>
                                            </tr>
                                            <tr data-href="{% url 'system_logs' %}" tabindex="0" role="button" aria-label="System Logs">
                                                <td><i class="bi bi-list-check"></i></td>
                                                <td>System Logs</td>
                                                <td class="text-end"><small class="text-muted">View background logs</small></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div style="white-space:nowrap">
                                    <a href="{% url 'enroll_tenant' %}" class="btn btn-outline-success">New Tenant</a>
                                </div>
                            </div>
                            {% if notice %}
                                <div class="alert alert-success">{{ notice }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 order-md-2">
                    <div class="card card-shadow">
                        <div class="card-header bg-secondary text-white">Messages Overview</div>
                        <div class="stat-card" id="statCard" data-total="{{ total_messages|default:0 }}" data-sent="{{ total_sent|default:0 }}">
                            <div>
                                <div class="small-muted">Recent activity</div>
                                <div class="stat-badges">
                                    <div class="stat-badge sent"><i class="bi bi-send-fill"></i> <span id="stat-sent">0</span></div>
                                    <div class="stat-badge pending"><i class="bi bi-hourglass-split"></i> <span id="stat-pending">0</span></div>
                                </div>
                            </div>
                            <div style="min-width:72px; text-align:center;">
                                <canvas id="messagesChart" width="80" height="80"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Removed duplicate Enrolled Organizations & Stats table — use Enrolled Orgs button above to view details -->

            <!-- Enroll form removed from dashboard — use the dedicated Enroll page instead -->
        </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        (function(){
            const ctx = document.getElementById('messagesChart');
            // Render a compact doughnut chart and populate numeric badges
            (function(){
                const statCard = document.getElementById('statCard');
                const canvas = document.getElementById('messagesChart');
                const total = statCard ? parseInt(statCard.dataset.total || 0, 10) : 0;
                const sent = statCard ? parseInt(statCard.dataset.sent || 0, 10) : 0;
                const pending = Math.max(0, total - sent);
                const sentEl = document.getElementById('stat-sent');
                const pendingEl = document.getElementById('stat-pending');
                if (sentEl) sentEl.textContent = sent;
                if (pendingEl) pendingEl.textContent = pending;
                if (canvas) {
                    try {
                        new Chart(canvas, {
                            type: 'doughnut',
                            data: { labels: ['Sent','Pending'], datasets: [{ data: [sent, pending], backgroundColor: ['#28a745','#ffc107'] }] },
                            options: { plugins: { legend: { display: false } }, cutout: '70%' }
                        });
                    } catch (e) {
                        console.error('Chart render error', e);
                    }
                }
            })();
        })();

        // Make table rows clickable when they have a data-href attribute.
        (function(){
            document.addEventListener('click', function(e){
                try {
                    // Find the nearest tr with data-href
                    const tr = e.target.closest && e.target.closest('tr[data-href]');
                    if (!tr) return;

                    // If the click was on an interactive element, don't hijack it
                    if (e.target.closest('a, button, input, textarea, select, label')) return;

                    const href = tr.getAttribute('data-href');
                    if (href) {
                        window.location.href = href;
                    }
                } catch (err) {
                    // swallow errors to avoid breaking the page
                    console.error('Row click handler error', err);
                }
            }, false);
        })();

        // Keyboard activation for quick-actions-table rows (Enter to activate)
        (function(){
            document.addEventListener('keydown', function(e){
                try {
                    if (e.key !== 'Enter') return;
                    var el = document.activeElement;
                    if (!el) return;
                    // If focused element is a tr with data-href, follow it
                    if (el.matches && el.matches('tr[data-href]')) {
                        var href = el.getAttribute('data-href');
                        if (href) window.location.href = href;
                    }
                } catch (err) {
                    console.error('Keydown handler error', err);
                }
            }, false);
        })();
    </script>
</body>
</html>