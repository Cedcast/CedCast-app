{% extends 'base.html' %}
{% load static %}

{% block title %}Super Admin — Dashboard{% endblock %}

{% block content %}

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="{% url 'dashboard' %}">
      <img src="{% static 'images/cedcast_logo.png' %}" alt="CedCast" style="height:32px; margin-right:8px;" onerror="this.style.display='none'">
      <span class="fw-bold">CedCast</span>
    </a>
    <div class="d-flex align-items-center gap-3">
      <div class="position-relative">
        <button class="btn btn-sm btn-light" id="notifBtn" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-bell"></i>
          <span class="badge bg-danger position-absolute top-0 start-100 translate-middle p-1">{{ notifications|length|default:0 }}</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="notifBtn" style="min-width:260px;">
          <li class="dropdown-header">Notifications</li>
                    {% for n in notifications %}
                        <li class="dropdown-item small">{{ n }}</li>
          {% empty %}
            <li class="dropdown-item small text-muted">No notifications</li>
          {% endfor %}
        </ul>
      </div>

      <div class="dropdown">
        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false" href="#">
          <div class="avatar rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width:34px; height:34px;">{{ request.user.username|slice:":1"|upper }}</div>
          <span class="ms-2 d-none d-sm-inline">{{ request.user.username }}</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
          <li><a class="dropdown-item" href="#">Profile</a></li>
          <li><a class="dropdown-item" href="#">Settings</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="/logout/">Logout</a></li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<div class="container py-4">
    {% if hubtel_dry_run or clicksend_dry_run %}
        <div class="alert alert-warning"> <strong>Test mode:</strong>
            {% if hubtel_dry_run %} Hubtel is running in dry-run mode — outgoing messages are simulated.{% endif %}
            {% if clicksend_dry_run %}{% if hubtel_dry_run %}<br>{% endif %} ClickSend is running in dry-run mode — outgoing messages are simulated.{% endif %}
        </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-12">
            <div class="card mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">Enrolled Organizations</h4>
                        <div class="text-muted small">Manage tenants, onboarding, and global templates.</div>
                    </div>
                    <div>
                        <a href="{% url 'enroll_tenant' %}" class="btn btn-primary me-2"><i class="bi bi-person-plus-fill"></i> New Tenant</a>
                        <a href="{% url 'super_orgs' %}" class="btn btn-outline-secondary"><i class="bi bi-people"></i> View all ({{ org_stats|length }})</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row gx-4 gy-3">
        <!-- Small metrics row (7-day sparklines) -->
        <div class="col-12 mb-3">
            <div class="row g-3">
                <div class="col-sm-4">
                    <div class="card p-2 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Messages (7d)</div>
                                <div class="h5 mb-0">{{ total_messages|default:0 }}</div>
                            </div>
                            <div style="width:120px;">
                                <canvas class="sparkline" id="sparkMessages" width="120" height="40" {% if messages_trend %}data-trend="{{ messages_trend|join:',' }}"{% endif %}></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="card p-2 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">New Orgs (7d)</div>
                                <div class="h5 mb-0">{{ org_stats|length }}</div>
                            </div>
                            <div style="width:120px;">
                                <canvas class="sparkline" id="sparkOrgs" width="120" height="40" {% if orgs_trend %}data-trend="{{ orgs_trend|join:',' }}"{% endif %}></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="card p-2 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Delivery % (7d)</div>
                                <div class="h5 mb-0">{{ total_sent|default:0 }}</div>
                            </div>
                            <div style="width:120px;">
                                <canvas class="sparkline" id="sparkDelivery" width="120" height="40" {% if delivery_trend %}data-trend="{{ delivery_trend|join:',' }}"{% endif %}></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-secondary text-white">Quick Actions</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <table class="table table-sm table-hover quick-actions-table mb-0">
                                <tbody>
                                    <tr data-href="{% url 'enroll_tenant' %}" tabindex="0">
                                        <td><i class="bi bi-person-plus-fill"></i></td>
                                        <td>Enroll Tenant</td>
                                        <td class="text-end text-muted small">Create a new tenant</td>
                                    </tr>
                                    <tr data-href="{% url 'super_orgs' %}" tabindex="0">
                                        <td><i class="bi bi-building"></i></td>
                                        <td>Onboarding</td>
                                        <td class="text-end text-muted small">Manage organizations</td>
                                    </tr>
                                    <tr data-href="{% url 'super_payments' %}" tabindex="0">
                                        <td><i class="bi bi-cash"></i></td>
                                        <td>Payment Analytics</td>
                                        <td class="text-end text-muted small">View payment history</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-4 d-flex align-items-center justify-content-center">
                            <a href="{% url 'enroll_tenant' %}" class="btn btn-success">New Tenant</a>
                        </div>
                    </div>
                    {% if notice %}<div class="alert alert-success mt-3">{{ notice }}</div>{% endif %}
                </div>
            </div>
        </div>

        <!-- Billing Analytics Row -->
        <div class="col-12 mb-3">
            <div class="row g-3">
                <div class="col-sm-3">
                    <div class="card p-2 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Total Revenue</div>
                                <div class="h5 mb-0">₵{{ total_revenue|floatformat:2 }}</div>
                            </div>
                            <div class="text-success">
                                <i class="bi bi-cash-stack fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="card p-2 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Payments (7d)</div>
                                <div class="h5 mb-0">{{ recent_payments }}</div>
                            </div>
                            <div style="width:120px;">
                                <canvas class="sparkline" id="sparkPayments" width="120" height="40" {% if payments_trend %}data-trend="{{ payments_trend|join:',' }}"{% endif %}></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="card p-2 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Orgs with Balance</div>
                                <div class="h5 mb-0">{{ orgs_with_balance }}</div>
                            </div>
                            <div class="text-info">
                                <i class="bi bi-building fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="card p-2 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Avg Balance</div>
                                <div class="h5 mb-0">₵{{ avg_org_balance|floatformat:2 }}</div>
                            </div>
                            <div class="text-warning">
                                <i class="bi bi-graph-up fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Payers Table -->
        {% if top_payers %}
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-trophy"></i> Top Paying Organizations</span>
                    <small class="text-white-50">{{ top_payers|length }} shown</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Organization</th>
                                    <th class="text-end">Current Balance</th>
                                    <th class="text-end">Total Paid</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payer in top_payers %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if payer.organization.logo %}
                                                <img src="{{ payer.organization.logo.url }}" alt="{{ payer.organization.name }}" class="rounded me-2" style="width:32px; height:32px; object-fit:cover;">
                                            {% else %}
                                                <div class="bg-secondary text-white rounded me-2 d-flex align-items-center justify-content-center" style="width:32px; height:32px;">
                                                    {{ payer.organization.name|slice:":1"|upper }}
                                                </div>
                                            {% endif %}
                                            <div>
                                                <div class="fw-bold">{{ payer.organization.name }}</div>
                                                <small class="text-muted">{{ payer.organization.org_type|title }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-success">₵{{ payer.balance|floatformat:2 }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">₵{{ payer.total_paid|floatformat:2 }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">Messages Overview</div>
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="small text-muted">Recent activity</div>
                        <div class="d-flex gap-2 mt-2">
                            <div class="badge bg-success"><i class="bi bi-send-fill"></i> <span id="stat-sent">0</span></div>
                            <div class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i> <span id="stat-pending">0</span></div>
                        </div>
                    </div>
                    <div id="statCard" data-total="{{ total_messages|default:0 }}" data-sent="{{ total_sent|default:0 }}" style="display:none;"></div>
                    <div style="width:90px; text-align:center;">
                        <canvas id="messagesChart" width="90" height="90"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        (function(){
            const statCard = document.getElementById('statCard');
            const canvas = document.getElementById('messagesChart');
            const total = statCard ? parseInt(statCard.dataset.total || 0, 10) : 0;
            const sent = statCard ? parseInt(statCard.dataset.sent || 0, 10) : 0;
            const pending = Math.max(0, total - sent);
            const sentEl = document.getElementById('stat-sent');
            const pendingEl = document.getElementById('stat-pending');
            if (sentEl) sentEl.textContent = sent;
            if (pendingEl) pendingEl.textContent = pending;
            if (canvas) {
                try {
                    new Chart(canvas, {
                        type: 'doughnut',
                        data: { labels: ['Sent','Pending'], datasets: [{ data: [sent, pending], backgroundColor: ['#28a745','#ffc107'] }] },
                        options: { plugins: { legend: { display: false } }, cutout: '70%' }
                    });
                } catch (e) { console.error('Chart render error', e); }
            }
        })();

        // keep quick-actions-table row click behavior
        document.addEventListener('click', function(e){
            try {
                const tr = e.target.closest && e.target.closest('tr[data-href]');
                if (!tr) return;
                if (e.target.closest('a, button, input, textarea, select, label')) return;
                const href = tr.getAttribute('data-href');
                if (href) window.location.href = href;
            } catch (err) { console.error(err); }
        }, false);
        
        // Render tiny sparklines from data-trend attributes
        (function(){
            try{
                const sparkCanvases = document.querySelectorAll('canvas.sparkline');
                sparkCanvases.forEach(function(c){
                    const dataAttr = c.getAttribute('data-trend') || '';
                    const vals = dataAttr ? dataAttr.split(',').map(x=>parseInt(x,10)||0) : [];
                    if (!vals.length) return;
                    try{
                        new Chart(c, {
                            type: 'line',
                            data: { labels: vals.map((_,i)=>i+1), datasets: [{ data: vals, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.06)', tension: 0.3, pointRadius: 0 }] },
                            options: { plugins: { legend: { display: false } }, elements: { line: { borderWidth: 2 } }, scales: { x: { display: false }, y: { display: false } }, responsive: false, maintainAspectRatio: false }
                        });
                    }catch(e){/* ignore chart render errors */}
                });
            }catch(e){console.error(e)}
        })();
    </script>
{% endblock %}