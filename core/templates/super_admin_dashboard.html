<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <title>CedCast SMS platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="{% static 'images/cedcast_logo.png' %}" alt="CedCast" style="height:36px; max-height:36px; object-fit:contain; display:inline-block; margin-right:8px;" onerror="this.style.display='none'">
                <span class="align-middle">CedCast SMS platform</span>
            </a>
                <div class="d-flex">
                    <a href="/logout/" class="btn btn-outline-light">Logout</a>
                </div>
            </div>
        </nav>

        <div class="container">
            {% if hubtel_dry_run or clicksend_dry_run %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-warning"> <strong>Test mode:</strong>
                        {% if hubtel_dry_run %} Hubtel is running in dry-run mode — outgoing messages are simulated.{% endif %}
                        {% if clicksend_dry_run %}{% if hubtel_dry_run %} {% endif %} {% if hubtel_dry_run %}<br>{% endif %} ClickSend is running in dry-run mode — outgoing messages are simulated.{% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            <div id="messages-section" class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">Enrolled Orgs &amp; Stats</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Organization Name</th>
                                            <th>Sender ID</th>
                                            <th>Total Messages</th>
                                            <th>Sent Messages</th>
                                            <th>Total Recipients</th>
                                            <th>Delivered</th>
                                            <th>Failed</th>
                                            <th>Delivery Rate (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for stat in org_stats %}
                                        {% if request.user.role == 'super_admin' %}
                                        <tr data-href="{% url 'super_edit_org' org_slug=stat.organization.slug %}" style="cursor:pointer;">
                                        {% else %}
                                        <tr data-href="{% url 'org_dashboard' org_slug=stat.organization.slug %}" style="cursor:pointer;">
                                        {% endif %}
                                            <td>{{ stat.organization.name }}</td>
                                            <td>{{ stat.sender_id_display|default:'—' }}</td>
                                            <td>{{ stat.total_messages }}</td>
                                            <td>{{ stat.sent_messages }}</td>
                                            <td>{{ stat.total_recipients }}</td>
                                            <td>{{ stat.sent_recipients }}</td>
                                            <td>{{ stat.failed_recipients }}</td>
                                            <td>{{ stat.delivery_rate|floatformat:2 }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center">No organizations enrolled yet.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card shadow">
                        <div class="card-header bg-secondary text-white">Messages Overview</div>
                        <div class="card-body text-center">
                            <canvas id="messagesChart" width="200" height="200" data-total="{{ total_messages|default:0 }}" data-sent="{{ total_sent|default:0 }}"></canvas>
                            <div class="mt-3">
                                <a href="{% url 'enroll_tenant' %}" class="btn btn-success">Enroll Tenant</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card shadow">
                        <div class="card-header bg-secondary text-white">Quick Actions</div>
                        <div class="card-body">
                            <p>Create tenants, view stats, and manage organizations from this dashboard.</p>
                            <div class="d-flex gap-2 mb-3">
                                <a href="{% url 'enroll_tenant' %}" class="btn btn-success">Enroll Tenant</a>
                                <a href="{% url 'onboarding' %}" class="btn btn-outline-primary">Onboarding</a>
                                <a href="{% url 'global_templates' %}" class="btn btn-outline-secondary">Global Templates</a>
                                <a href="{% url 'system_logs' %}" class="btn btn-outline-dark">System Logs</a>
                            </div>
                            {% if notice %}
                                <div class="alert alert-success">{{ notice }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">Enrolled Organizations & Stats</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Sender ID</th>
                                            <th>Total Messages</th>
                                            <th>Sent Messages</th>
                                            <th>Total Recipients</th>
                                            <th>Delivered</th>
                                            <th>Failed</th>
                                            <th>Delivery Rate (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for stat in org_stats %}
                                        {% if request.user.role == 'super_admin' %}
                                        <tr data-href="{% url 'super_edit_org' org_slug=stat.organization.slug %}" style="cursor:pointer;">
                                        {% else %}
                                        <tr data-href="{% url 'org_dashboard' org_slug=stat.organization.slug %}" style="cursor:pointer;">
                                        {% endif %}
                                            <td>{{ stat.organization.name }}</td>
                                            <td>{{ stat.organization.org_type }}</td>
                                        <td>{{ stat.sender_id_display|default:'—' }}</td>
                                            <td>{{ stat.total_messages }}</td>
                                            <td>{{ stat.sent_messages }}</td>
                                            <td>{{ stat.total_recipients }}</td>
                                            <td>{{ stat.sent_recipients }}</td>
                                            <td>{{ stat.failed_recipients }}</td>
                                            <td>{{ stat.delivery_rate|floatformat:2 }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center">No organizations enrolled yet.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enroll form removed from dashboard — use the dedicated Enroll page instead -->
        </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        (function(){
            const ctx = document.getElementById('messagesChart');
            const total = ctx ? parseInt(ctx.dataset.total || 0, 10) : 0;
            const sent = ctx ? parseInt(ctx.dataset.sent || 0, 10) : 0;
            const pending = Math.max(0, total - sent);
            if (ctx) {
                const chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Sent', 'Pending'],
                        datasets: [{
                            data: [sent, pending],
                            backgroundColor: ['#28a745', '#ffc107']
                        }]
                    },
                    options: {
                        plugins: { legend: { position: 'bottom' } },
                        onClick: (evt, elems) => {
                            if (!elems.length) return;
                            // Always jump to messages section for now
                            window.location.hash = '#messages-section';
                        }
                    }
                });
            }
        })();

        // Make table rows clickable when they have a data-href attribute.
        (function(){
            document.addEventListener('click', function(e){
                try {
                    // Find the nearest tr with data-href
                    const tr = e.target.closest && e.target.closest('tr[data-href]');
                    if (!tr) return;

                    // If the click was on an interactive element, don't hijack it
                    if (e.target.closest('a, button, input, textarea, select, label')) return;

                    const href = tr.getAttribute('data-href');
                    if (href) {
                        window.location.href = href;
                    }
                } catch (err) {
                    // swallow errors to avoid breaking the page
                    console.error('Row click handler error', err);
                }
            }, false);
        })();
    </script>
</body>
</html>