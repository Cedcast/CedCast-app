<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="CedCast - SMS Communication Platform">
    <title>{% block title %}CedCast{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{% static 'images/favicon.svg' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/favicon.svg' %}">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="{% static 'images/favicon.svg' %}">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="{% static 'images/favicon.svg' %}">

    <!-- Bootstrap CSS + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom styles -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    {% block extra_head %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
    {% block content %}{% endblock %}

    <!-- Bootstrap JS bundle (for dropdowns, collapse, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% if user.is_authenticated %}
    <script>
        let logoutTimer;
        const LOGOUT_TIME = 5 * 60 * 1000; // 5 minutes in milliseconds
        const WARNING_TIME = 1 * 60 * 1000; // Show warning 1 minute before logout
        let lastActivity = Date.now();

        function resetTimer() {
            clearTimeout(logoutTimer);
            lastActivity = Date.now();
            logoutTimer = setTimeout(logout, LOGOUT_TIME);
        }

        function logout() {
            // Show logout message
            const logoutModal = new bootstrap.Modal(document.getElementById('logoutModal') || createLogoutModal());
            logoutModal.show();

            // Auto logout after showing modal for 5 seconds
            setTimeout(() => {
                window.location.href = '/logout/';
            }, 5000);
        }

        function createLogoutModal() {
            const modalHTML = `
                <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title" id="logoutModalLabel">
                                    <i class="bi bi-clock-history me-2"></i>Session Timeout
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <i class="bi bi-shield-lock text-warning" style="font-size: 3rem;"></i>
                                <h5 class="mt-3">You have been logged out due to inactivity</h5>
                                <p class="text-muted">For security reasons, you will be redirected to the login page.</p>
                                <div class="mt-3">
                                    <div class="spinner-border text-warning" role="status">
                                        <span class="visually-hidden">Logging out...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            return document.getElementById('logoutModal');
        }

        // Track user activity
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, resetTimer, true);
        });

        // Start the timer
        resetTimer();

        // Show warning before logout
        setInterval(() => {
            const timeLeft = LOGOUT_TIME - (Date.now() - lastActivity);
            if (timeLeft <= WARNING_TIME && timeLeft > 0 && !document.getElementById('inactivityWarning')) {
                showInactivityWarning(Math.ceil(timeLeft / 1000 / 60));
            }
        }, 30000); // Check every 30 seconds

        function showInactivityWarning(minutesLeft) {
            const warningHTML = `
                <div class="alert alert-warning alert-dismissible fade show position-fixed" id="inactivityWarning" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Inactivity Warning:</strong> You will be logged out in ${minutesLeft} minute${minutesLeft > 1 ? 's' : ''} due to inactivity.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', warningHTML);

            // Auto-dismiss warning after 10 seconds
            setTimeout(() => {
                const warning = document.getElementById('inactivityWarning');
                if (warning) {
                    warning.remove();
                }
            }, 10000);
        }
    </script>
    {% endif %}
    {% block extra_scripts %}{% endblock %}
</body>
</html>
