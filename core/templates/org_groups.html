{% extends "base.html" %}
{% load static %}

{% block title %}{{ organization.name }} - Contact Groups{% endblock %}

{% block content %}
{% include "org_admin_nav.html" %}

<div class="container-fluid py-4" style="background: #f8f9fa; min-height: calc(100vh - 76px);">
    <div class="container">

        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="mb-2 text-primary" style="font-weight: 700;">
                            <i class="fas fa-users me-3"></i>Contact Groups
                        </h1>
                        <p class="text-muted mb-0">Organize your contacts into groups for targeted messaging</p>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-primary px-3 py-2">
                            <i class="fas fa-building me-1"></i>{{ organization.name }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if notice %}
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-check-circle me-2"></i>{{ notice }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <div class="row g-4">
            <!-- Create/Edit Group Section -->
            <div class="col-lg-5">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-plus-circle me-2"></i>
                            {% if edit_group %}Edit Group{% else %}Create New Group{% endif %}
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form method="post" id="groupForm">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="{% if edit_group %}edit{% else %}create{% endif %}">
                            {% if edit_group %}
                            <input type="hidden" name="group_id" value="{{ edit_group.id }}">
                            {% endif %}

                            <div class="mb-4">
                                <label for="groupName" class="form-label fw-semibold text-primary">
                                    <i class="fas fa-tag me-2"></i>Group Name
                                </label>
                                <input type="text" id="groupName" name="name" class="form-control form-control-lg"
                                       value="{% if edit_group %}{{ edit_group.name }}{% endif %}"
                                       placeholder="e.g., Staff, Parents, Students" required>
                                <div class="form-text">Choose a descriptive name for your contact group</div>
                            </div>

                            <div class="mb-4">
                                <label for="groupContacts" class="form-label fw-semibold text-primary">
                                    <i class="fas fa-address-book me-2"></i>Select Contacts
                                </label>
                                <select id="groupContacts" name="contacts" multiple class="form-select" size="8">
                                    {% for c in contacts %}
                                    <option value="{{ c.id }}"
                                            {% if edit_group and c in edit_group.contacts.all %}selected{% endif %}>
                                        {{ c.name }} â€” {{ c.phone_number }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Hold Ctrl (Cmd on Mac) to select multiple contacts
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>
                                    {% if edit_group %}Update Group{% else %}Create Group{% endif %}
                                </button>
                                {% if edit_group %}
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="cancelEdit()">
                                    <i class="fas fa-times me-2"></i>Cancel Edit
                                </button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Groups List Section -->
            <div class="col-lg-7">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Your Groups
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        {% if groups %}
                        <div class="row g-3">
                            {% for g in groups %}
                            <div class="col-12">
                                <div class="card border">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 text-primary fw-semibold">
                                                    <i class="fas fa-users me-2"></i>{{ g.name }}
                                                </h6>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-secondary me-3">
                                                        <i class="fas fa-user-friends me-1"></i>{{ g.contacts.count }} contacts
                                                    </span>
                                                    {% if g.contacts.count > 0 %}
                                                    <small class="text-muted">
                                                        Last contact: {{ g.contacts.first.name }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-primary btn-sm" onclick="editGroup({{ g.id }}, '{{ g.name }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="deleteGroup({{ g.id }}, '{{ g.name }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <div class="display-1 text-muted mb-3">
                                <i class="fas fa-users"></i>
                            </div>
                            <h5 class="text-muted mb-3">No Groups Yet</h5>
                            <p class="text-muted mb-4">Create your first contact group to get started with organized messaging</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Group
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure you want to delete the group "<strong id="deleteGroupName"></strong>"?</p>
                <p class="text-muted mt-2 mb-0">This action cannot be undone. The contacts will remain but the group will be permanently removed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" id="deleteForm" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="group_id" id="deleteGroupId">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Group
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function editGroup(groupId, groupName) {
    // Scroll to form and highlight it
    document.getElementById('groupForm').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('groupName').focus();
}

function deleteGroup(groupId, groupName) {
    document.getElementById('deleteGroupId').value = groupId;
    document.getElementById('deleteGroupName').textContent = groupName;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function cancelEdit() {
    window.location.href = window.location.pathname; // Reload page to clear edit state
}

// Add form validation
document.getElementById('groupForm').addEventListener('submit', function(e) {
    const nameInput = document.getElementById('groupName');

    if (!nameInput.value.trim()) {
        e.preventDefault();
        nameInput.focus();
        return;
    }
});
</script>
{% endblock %}
