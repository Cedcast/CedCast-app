{% extends 'base.html' %}
{% load static %}
{% block title %}Contacts - {{ organization.name }}{% endblock %}

{% block content %}
{% include 'org_admin_combined_nav.html' %}

<div class="container-fluid py-4 org-admin-page">
    <div class="container">

        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="mb-2 text-primary fw-bold">
                            <i class="fas fa-address-book me-3"></i>Contacts Management
                        </h1>
                        <p class="text-muted mb-0">Manage your organization's contact database and import new contacts</p>
                    </div>
                    <div class="text-end">
                        <div class="d-flex align-items-center">
                            <div class="badge bg-primary px-3 py-2 me-3">
                                <i class="fas fa-users me-1"></i>{{ contacts|length }} Total
                            </div>
                            <div class="badge bg-primary px-3 py-2">
                                <i class="fas fa-building me-1"></i>{{ organization.name }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if message %}
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-info-circle me-2"></i>{{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <div class="row g-4">
            <!-- Existing Contacts -->
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Your Contacts
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        {% if contacts %}
                        <div class="mb-3">
                            <input type="text" id="searchContacts" class="form-control"
                                   placeholder="Search contacts..." style="max-width: 300px;">
                        </div>

                        <div class="table-responsive">
                            <form id="bulkDeleteForm" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="bulk_delete_contacts">
                                
                                <!-- Bulk Actions Bar -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <button type="button" id="selectAllBtn" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-check-square me-1"></i>Select All
                                        </button>
                                        <button type="button" id="deselectAllBtn" class="btn btn-outline-secondary btn-sm d-none">
                                            <i class="fas fa-square me-1"></i>Deselect All
                                        </button>
                                        <span id="selectedCount" class="ms-2 text-muted">0 selected</span>
                                    </div>
                                    <div>
                                        <button type="submit" id="bulkDeleteBtn" class="btn btn-danger btn-sm d-none">
                                            <i class="fas fa-trash me-1"></i>Delete Selected
                                        </button>
                                    </div>
                                </div>

                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
                                            </th>
                                            <th><i class="fas fa-user me-1"></i>Name</th>
                                            <th><i class="fas fa-phone me-1"></i>Phone Number</th>
                                            <th class="text-end"><i class="fas fa-cogs me-1"></i>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contactsTableBody">
                                        {% for c in contacts %}
                                        <tr data-name="{{ c.name|lower }}" data-phone="{{ c.phone_number }}">
                                            <td>
                                                <input type="checkbox" name="selected_contacts" value="{{ c.id }}" 
                                                       class="form-check-input contact-checkbox">
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                                         style="width: 32px; height: 32px; font-size: 14px; font-weight: bold;">
                                                        {{ c.name|slice:":1"|upper }}
                                                    </div>
                                                    <span class="fw-semibold">{{ c.name }}</span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="font-monospace">{{ c.phone_number }}</span>
                                            </td>
                                            <td class="text-end">
                                                <button class="btn btn-outline-primary btn-sm me-1"
                                                        onclick="editContact({{ c.id }}, '{{ c.name }}', '{{ c.phone_number }}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm"
                                                        onclick="deleteContact({{ c.id }}, '{{ c.name }}')">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </form>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <div class="display-1 text-muted mb-3">
                                <i class="fas fa-address-book"></i>
                            </div>
                            <h5 class="text-muted mb-3">No Contacts Yet</h5>
                            <p class="text-muted">Use the import methods on the right to add your first contacts</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Import Methods Sidebar -->
            <div class="col-lg-4">
                <!-- Add/Edit Contact -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-user-plus me-2"></i>Add New Contact
                        </h6>
                    </div>
                    <div class="card-body">
                        <form method="post" id="contactForm">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="add_contact" id="contactAction">
                            <input type="hidden" name="contact_id" value="" id="contactId">

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Full Name</label>
                                <input type="text" name="name" id="contactName" class="form-control"
                                       placeholder="Enter contact name" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Phone Number</label>
                                <input type="tel" name="phone" id="contactPhone" class="form-control"
                                       placeholder="+233501234567 or 0550123456" required>
                                <div class="form-text">Include country code for international numbers</div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success flex-fill" id="submitBtn">
                                    <i class="fas fa-plus-circle me-1"></i>Add Contact
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="cancelBtn" style="display: none;">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Import Methods -->
                <div class="row g-3">
                    <!-- Paste Import -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-clipboard me-2"></i>Paste Contacts
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Quickly add multiple contacts by pasting a list</p>

                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="paste_contacts">
                                    <div class="mb-3">
                                        <textarea name="pasted" rows="4" class="form-control"
                                                  placeholder="John Doe, +233555000111&#10;Jane Smith, 0555000222&#10;Bob Johnson, +233244000333"></textarea>
                                        <div class="form-text small">Format: Name, Phone (one per line)</div>
                                    </div>
                                    <button type="submit" class="btn btn-warning btn-sm w-100">
                                        <i class="fas fa-clipboard-check me-1"></i>Import Pasted
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-file-upload me-2"></i>Upload File
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Import contacts from CSV or Excel files</p>

                                <form method="post" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="upload_file">
                                    <div class="mb-3">
                                        <input type="file" name="contacts_file" class="form-control"
                                               accept=".csv,.xlsx,.xls">
                                        <div class="form-text small">Supported: CSV, Excel (.xlsx, .xls)</div>
                                    </div>
                                    <button type="submit" class="btn btn-info btn-sm w-100">
                                        <i class="fas fa-upload me-1"></i>Upload File
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Contact
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure you want to delete <strong id="deleteContactName"></strong>? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" id="deleteForm" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_contact">
                    <input type="hidden" name="contact_id" value="" id="deleteContactId">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>Delete Contact
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Search functionality
    document.getElementById('searchContacts').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#contactsTableBody tr');

        rows.forEach(row => {
            const name = row.dataset.name;
            const phone = row.dataset.phone;
            const matches = name.includes(searchTerm) || phone.includes(searchTerm);
            row.style.display = matches ? '' : 'none';
        });
    });

    // Edit contact function
    function editContact(id, name, phone) {
        document.getElementById('contactAction').value = 'add_contact';
        document.getElementById('contactId').value = id;
        document.getElementById('contactName').value = name;
        document.getElementById('contactPhone').value = phone;
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-check-circle me-1"></i>Update Contact';
        document.getElementById('cancelBtn').style.display = 'block';
        document.getElementById('contactName').focus();

        // Scroll to form
        document.querySelector('#contactForm').scrollIntoView({ behavior: 'smooth' });
    }

    // Cancel edit
    document.getElementById('cancelBtn').addEventListener('click', function() {
        resetContactForm();
    });

    // Reset contact form
    function resetContactForm() {
        document.getElementById('contactForm').reset();
        document.getElementById('contactAction').value = 'add_contact';
        document.getElementById('contactId').value = '';
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-plus-circle me-1"></i>Add Contact';
        document.getElementById('cancelBtn').style.display = 'none';
    }

    // Delete contact function
    function deleteContact(id, name) {
        document.getElementById('deleteContactId').value = id;
        document.getElementById('deleteContactName').textContent = name;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    // Form submission handling
    document.getElementById('contactForm').addEventListener('submit', function(e) {
        // Reset form after successful submission (will be handled by page reload)
        setTimeout(resetContactForm, 100);
    });

    // Bulk selection functionality
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const contactCheckboxes = document.querySelectorAll('.contact-checkbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const selectedCount = document.getElementById('selectedCount');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

    function updateSelectionUI() {
        const checkedBoxes = document.querySelectorAll('.contact-checkbox:checked');
        const totalChecked = checkedBoxes.length;
        
        selectedCount.textContent = `${totalChecked} selected`;
        
        if (totalChecked > 0) {
            bulkDeleteBtn.classList.remove('d-none');
        } else {
            bulkDeleteBtn.classList.add('d-none');
        }
        
        // Update select all checkbox state
        const totalCheckboxes = contactCheckboxes.length;
        if (totalChecked === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (totalChecked === totalCheckboxes) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
            selectAllCheckbox.checked = false;
        }
    }

    // Select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        contactCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateSelectionUI();
    });

    // Individual checkboxes
    contactCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionUI);
    });

    // Select All button
    selectAllBtn.addEventListener('click', function() {
        contactCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectionUI();
        selectAllBtn.classList.add('d-none');
        deselectAllBtn.classList.remove('d-none');
    });

    // Deselect All button
    deselectAllBtn.addEventListener('click', function() {
        contactCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectionUI();
        deselectAllBtn.classList.add('d-none');
        selectAllBtn.classList.remove('d-none');
    });

    // Bulk delete confirmation
    bulkDeleteBtn.addEventListener('click', function(e) {
        const checkedBoxes = document.querySelectorAll('.contact-checkbox:checked');
        if (checkedBoxes.length === 0) {
            e.preventDefault();
            return;
        }
        
        const confirmMessage = `Are you sure you want to delete ${checkedBoxes.length} selected contact(s)? This action cannot be undone.`;
        if (!confirm(confirmMessage)) {
            e.preventDefault();
        }
    });

    // Initialize selection UI
    updateSelectionUI();
</script>
{% endblock %}