{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}{{ organization.name }} - Billing{% endblock %}
{% block extra_head %}
<script src="https://js.paystack.co/v1/inline.js"></script>
{% endblock %}
{% block content %}
    <div class="container py-4">
        {% csrf_token %}
        <h2 class="mb-4">Billing & Balance</h2>
        {% if message %}
            <div class="alert alert-info">{{ message }}</div>
        {% endif %}
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Current Balance</h5>
                    </div>
                    <div class="card-body">
                        <h3 class="text-primary">₵{{ organization.balance|floatformat:2 }}</h3>
                        <p class="text-muted">Available SMS credits: {{ available_sms|intcomma }} (approx.)</p>
                        {% if organization.balance < sms_min_balance %}
                        <div class="alert alert-warning mt-2">
                            <small><i class="bi bi-exclamation-triangle"></i> Low balance warning! Minimum balance: ₵{{ sms_min_balance }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Add Balance</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount (GHS)</label>
                            <input type="number" step="0.01" min="0.01" max="10000" class="form-control" id="amount" placeholder="Enter amount">
                            <div class="form-text">Minimum: ₵0.01, Maximum: ₵10,000</div>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg w-100" onclick="showPaymentModal()">Add to Balance</button>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-shield-check"></i>
                                Secure payments powered by Paystack
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Pricing Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h6 class="text-muted">Cost per SMS</h6>
                                <h4 class="text-primary">₵{{ sms_customer_rate|floatformat:2 }}</h4>
                                <small class="text-muted">(what you pay)</small>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted">Minimum Balance</h6>
                                <h4 class="text-warning">₵{{ sms_min_balance|floatformat:2 }}</h4>
                                <small class="text-muted">(required)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>SMS Cost Calculator</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="calc_sms_count" class="form-label">Number of SMS</label>
                            <input type="number" class="form-control" id="calc_sms_count" placeholder="1000" min="1">
                        </div>
                        <div class="row text-center">
                            <div class="col-6">
                                <h6 class="text-muted">Cost per SMS</h6>
                                <p id="calc_rate" class="h5 text-primary mb-0">₵{{ sms_customer_rate|floatformat:2 }}</p>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted">Total Cost</h6>
                                <p id="calc_total" class="h5 text-success mb-0">₵0.00</p>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">Calculate the total cost for your SMS campaign</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Choose Payment Method</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <h6>Amount to Pay: <span id="modalAmount" class="text-primary fw-bold">₵0.00</span></h6>
                    </div>
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-outline-primary btn-lg" onclick="payWithPaystack('card')">
                            <i class="bi bi-credit-card"></i> Pay with Card
                        </button>
                        <button type="button" class="btn btn-outline-success btn-lg" onclick="payWithPaystack('mobile')">
                            <i class="bi bi-phone"></i> Pay with Mobile Money
                        </button>
                    </div>
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="bi bi-shield-check"></i>
                            Secure payment powered by Paystack
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
function showPaymentModal() {
    const amount = document.getElementById('amount').value;
    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }

    if (amount > 10000) {
        alert('Maximum amount is 10,000 GHS');
        return;
    }

    // Update modal with amount
    document.getElementById('modalAmount').textContent = '₵' + parseFloat(amount).toFixed(2);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

function payWithPaystack(paymentMethod) {
    const amount = document.getElementById('amount').value;
    const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
    modal.hide();

    // Show loading
    const payBtn = document.querySelector(`[onclick="payWithPaystack('${paymentMethod}')"]`);
    const originalText = payBtn.innerHTML;
    payBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    payBtn.disabled = true;

    // Send AJAX request to initialize payment
    fetch('{% url "org_billing" organization.slug %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            'action': 'add_balance',
            'amount': amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to Paystack payment page
            window.location.href = data.payment_url;
        } else {
            alert('Error: ' + data.message);
            payBtn.innerHTML = originalText;
            payBtn.disabled = false;
        }
    })
    .catch(error => {
        alert('Payment initialization failed. Please try again.');
        payBtn.innerHTML = originalText;
        payBtn.disabled = false;
    });
}

// SMS Cost Calculator
document.addEventListener('DOMContentLoaded', function() {
    const smsCountInput = document.getElementById('calc_sms_count');
    const rateEl = document.getElementById('calc_rate');
    const totalEl = document.getElementById('calc_total');

    const customerRate = parseFloat('{{ sms_customer_rate|floatformat:2 }}');

    function updateCalculator() {
        const smsCount = parseInt(smsCountInput.value) || 0;
        const total = smsCount * customerRate;

        rateEl.textContent = '₵' + customerRate.toFixed(2);
        totalEl.textContent = '₵' + total.toFixed(2);
    }

    smsCountInput.addEventListener('input', updateCalculator);
    // Set default value and calculate
    smsCountInput.value = 1000;
    updateCalculator();
});
</script>
{% endblock %}