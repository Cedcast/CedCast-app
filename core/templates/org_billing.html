{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}{{ organization.name }} - Billing{% endblock %}
{% block content %}
    <div class="container py-4">
        <h2 class="mb-4">Billing & Balance</h2>
        {% if message %}
            <div class="alert alert-info">{{ message }}</div>
        {% endif %}
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Current Balance</h5>
                    </div>
                    <div class="card-body">
                        <h3 class="text-primary">₵{{ organization.balance|floatformat:2 }}</h3>
                        <p class="text-muted">Available SMS credits: {{ available_sms|intcomma }} (approx.)</p>
                        {% if organization.balance < sms_min_balance %}
                        <div class="alert alert-warning mt-2">
                            <small><i class="bi bi-exclamation-triangle"></i> Low balance warning! Minimum balance: ₵{{ sms_min_balance }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Add Balance</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'org_billing' organization.slug %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="add_balance">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount (GHS)</label>
                                <input type="number" step="0.01" min="0.01" max="10000" class="form-control" id="amount" name="amount" placeholder="Enter amount" required>
                                <div class="form-text">Minimum: ₵0.01, Maximum: ₵10,000</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Add to Balance</button>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    After submitting, you'll receive payment instructions via email to complete your balance addition.
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Pricing Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h6 class="text-muted">Cost per SMS</h6>
                                <h4 class="text-primary">₵{{ sms_customer_rate|floatformat:2 }}</h4>
                                <small class="text-muted">(what you pay)</small>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted">Minimum Balance</h6>
                                <h4 class="text-warning">₵{{ sms_min_balance|floatformat:2 }}</h4>
                                <small class="text-muted">(required)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>SMS Cost Calculator</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="calc_sms_count" class="form-label">Number of SMS</label>
                            <input type="number" class="form-control" id="calc_sms_count" placeholder="1000" min="1">
                        </div>
                        <div class="row text-center">
                            <div class="col-6">
                                <h6 class="text-muted">Cost per SMS</h6>
                                <p id="calc_rate" class="h5 text-primary mb-0">₵{{ sms_customer_rate|floatformat:2 }}</p>
                            </div>
                            <div class="col-6">
                                <h6 class="text-muted">Total Cost</h6>
                                <p id="calc_total" class="h5 text-success mb-0">₵0.00</p>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">Calculate the total cost for your SMS campaign</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
// SMS Cost Calculator
document.addEventListener('DOMContentLoaded', function() {
    const smsCountInput = document.getElementById('calc_sms_count');
    const rateEl = document.getElementById('calc_rate');
    const totalEl = document.getElementById('calc_total');

    const customerRate = parseFloat('{{ sms_customer_rate|floatformat:2 }}');

    function updateCalculator() {
        const smsCount = parseInt(smsCountInput.value) || 0;
        const total = smsCount * customerRate;

        rateEl.textContent = '₵' + customerRate.toFixed(2);
        totalEl.textContent = '₵' + total.toFixed(2);
    }

    smsCountInput.addEventListener('input', updateCalculator);
    // Set default value and calculate
    smsCountInput.value = 1000;
    updateCalculator();
});
</script>
{% endblock %}