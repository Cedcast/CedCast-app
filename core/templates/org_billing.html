{% extends "base.html" %}
{% load static %}
{% load core_filters %}

{% block title %}{{ organization.name }} - Billing{% endblock %}

{% block content %}
{% include "org_admin_combined_nav.html" %}

<div class="container-fluid py-4 org-admin-page">
    <div class="container">
        {% csrf_token %}

        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="mb-2 text-primary fw-bold">
                            <i class="fas fa-credit-card me-3"></i>Billing & Payments
                        </h1>
                        <p class="text-muted mb-0">Manage your account balance and payment history</p>
                    </div>
                    <div class="text-end">
                        <div class="d-flex align-items-center">
                            <div class="badge bg-success me-3 px-3 py-2">
                                <i class="fas fa-wallet me-1"></i>₵{{ organization.balance|floatformat:2 }}
                            </div>
                            <div class="badge bg-primary px-3 py-2">
                                <i class="fas fa-building me-1"></i>{{ organization.name }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if message %}
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-info-circle me-2"></i>{{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Key Metrics Row -->
        <div class="row mb-4 g-4">
            <!-- Current Balance -->
            <div class="col-lg-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-wallet me-2"></i>Current Balance
                        </h5>
                    </div>
                    <div class="card-body p-4 text-center">
                        <div class="display-4 fw-bold mb-2 text-primary">₵{{ organization.balance|floatformat:2 }}</div>
                        <p class="text-muted mb-0">Available SMS credits</p>

                        {% if organization.balance < current_sms_rate %}
                        <div class="alert alert-warning border-0 mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Low Balance!</strong> You need at least ₵{{ current_sms_rate|floatformat:4 }} to send one SMS.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- SMS Usage & Pricing -->
            <div class="col-lg-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>SMS Usage & Pricing
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                    <span class="fw-semibold">Current Rate:</span>
                                    <span class="h4 mb-0 fw-bold text-primary">₵{{ current_sms_rate|floatformat:4 }}</span>
                                </div>
                                <small class="text-muted">per SMS (decreases with volume)</small>
                            </div>

                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                    <span class="fw-semibold">Total SMS Sent:</span>
                                    <span class="h5 mb-0 fw-bold">{{ total_sms_sent|format_number }}</span>
                                </div>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3 text-primary">
                            <i class="fas fa-tags me-2"></i>Pricing Tiers
                        </h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="p-2 text-center bg-light rounded">
                                    <div class="small fw-bold text-primary">0-99 SMS</div>
                                    <div class="fw-semibold">₵0.25 each</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 text-center bg-light rounded">
                                    <div class="small fw-bold text-primary">100-499 SMS</div>
                                    <div class="fw-semibold">₵0.22 each</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 text-center bg-light rounded">
                                    <div class="small fw-bold text-primary">500-999 SMS</div>
                                    <div class="fw-semibold">₵0.20 each</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 text-center bg-light rounded">
                                    <div class="small fw-bold text-primary">1,000-4,999 SMS</div>
                                    <div class="fw-semibold">₵0.18 each</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 text-center bg-light rounded">
                                    <div class="small fw-bold text-primary">5,000-9,999 SMS</div>
                                    <div class="fw-semibold">₵0.16 each</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 text-center bg-primary text-white rounded">
                                    <div class="small fw-bold">10,000+ SMS</div>
                                    <div class="fw-semibold">₵0.14 each</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Analytics and Payment History -->
        <div class="row mb-4 g-4">
            <!-- Usage Analytics -->
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>SMS Usage Trends (Last 6 Months)
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if monthly_usage %}
                        <canvas id="usageChart" width="400" height="200"></canvas>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No usage data available yet</p>
                            <small class="text-muted">Start sending SMS to see your usage trends</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-tachometer-alt me-2"></i>Quick Stats
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">SMS Sent (30 days):</span>
                                <strong class="text-primary">{{ sms_usage.total_sent|default:0 }}</strong>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Cost (30 days):</span>
                                <strong class="text-success">₵{{ sms_usage.total_cost|default:0|floatformat:2 }}</strong>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Projected Monthly:</span>
                                <strong class="text-warning">₵{{ projected_monthly_cost|floatformat:2 }}</strong>
                            </div>
                        </div>
                        <hr>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Avg. Cost per SMS:</span>
                                <strong>₵{{ current_sms_rate|floatformat:2 }}</strong>
                            </div>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                Send more SMS to get lower rates
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Volume-Based Pricing Tiers -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-tags me-2"></i>Volume-Based Pricing - Save More by Sending More!
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Your SMS rate decreases as you send more messages. Current rate: <strong class="text-primary">₵{{ current_sms_rate|floatformat:2 }}</strong> per SMS</p>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card border-primary h-100 {% if total_sms_sent < 500 %}bg-primary bg-opacity-10{% endif %}">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-primary">Starter</h6>
                                        <h4 class="text-primary fw-bold">₵0.22</h4>
                                        <small class="text-muted">0 - 500 SMS/month</small>
                                        {% if total_sms_sent < 500 %}
                                        <div class="mt-2">
                                            <span class="badge bg-primary">Your Current Tier</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success h-100 {% if total_sms_sent >= 500 and total_sms_sent < 5000 %}bg-success bg-opacity-10{% endif %}">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-success">Professional</h6>
                                        <h4 class="text-success fw-bold">₵0.18</h4>
                                        <small class="text-muted">500 - 5,000 SMS/month</small>
                                        {% if total_sms_sent >= 500 and total_sms_sent < 5000 %}
                                        <div class="mt-2">
                                            <span class="badge bg-success">Your Current Tier</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-warning h-100 {% if total_sms_sent >= 5000 %}bg-warning bg-opacity-10{% endif %}">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-warning">Enterprise</h6>
                                        <h4 class="text-warning fw-bold">₵0.14</h4>
                                        <small class="text-muted">5,000+ SMS/month</small>
                                        {% if total_sms_sent >= 5000 %}
                                        <div class="mt-2">
                                            <span class="badge bg-warning">Your Current Tier</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Volume Discount:</strong> Your rate is automatically updated based on your monthly SMS volume. Send more to save more!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment History -->
        {% if payment_history %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Recent Payment History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in payment_history %}
                                    <tr>
                                        <td>{{ payment.created_at|date:"M d, Y H:i" }}</td>
                                        <td class="fw-bold text-success">₵{{ payment.amount|floatformat:2 }}</td>
                                        <td>
                                            {% if payment.status == 'success' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Success
                                                </span>
                                            {% elif payment.status == 'pending' %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-clock me-1"></i>Pending
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times me-1"></i>Failed
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ payment.paystack_reference|truncatechars:20 }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if payment_history|length >= 10 %}
                        <div class="text-center mt-3">
                            <a href="#" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-eye me-1"></i>View All Payments
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Add Balance Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-plus-circle me-2"></i>Add Balance
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <div class="p-4 bg-light rounded">
                                    <label for="amount" class="form-label fw-semibold mb-3 text-primary">
                                        <i class="fas fa-money-bill-wave me-2"></i>Amount (GHS)
                                    </label>
                                    <input type="number" step="0.01" min="{{ min_payment_amount }}" max="{{ max_payment_amount }}" class="form-control form-control-lg" id="amount" placeholder="Enter amount in Ghana Cedis">
                                    <div class="form-text mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Minimum: ₵{{ min_payment_amount }}, Maximum: ₵{{ max_payment_amount|floatformat:0|format_number }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 d-flex align-items-end">
                                <button type="button" class="btn btn-primary btn-lg w-100 fw-bold" id="addBalanceBtn" onclick="showPaymentModal()" disabled>
                                    <i class="fas fa-credit-card me-2"></i>Add to Balance
                                </button>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <div class="badge bg-light text-muted px-4 py-2 rounded-pill">
                                <i class="fas fa-shield-alt text-success me-2"></i>
                                Secure payments powered by Paystack
                            </div>
                        </div>

                        <!-- Quick Amount Buttons -->
                        <div class="mt-4">
                            <label class="form-label fw-semibold mb-3 text-primary">
                                <i class="fas fa-bolt me-2"></i>Quick Amounts
                            </label>
                            <div class="row g-2">
                                <div class="col-6 col-md-3">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="setAmount(10)">
                                        ₵10
                                    </button>
                                </div>
                                <div class="col-6 col-md-3">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="setAmount(25)">
                                        ₵25
                                    </button>
                                </div>
                                <div class="col-6 col-md-3">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="setAmount(50)">
                                        ₵50
                                    </button>
                                </div>
                                <div class="col-6 col-md-3">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="setAmount(100)">
                                        ₵100
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        </div>
    </div>
</div>

<!-- Payment Method Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary" id="paymentModalLabel">
                    <i class="fas fa-credit-card me-2"></i>Choose Payment Method
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="p-3 mb-4 bg-light rounded">
                        <small class="text-muted d-block mb-1">Amount to Pay</small>
                        <h4 id="modalAmount" class="mb-0 fw-bold text-primary">₵0.00</h4>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-6">
                        <button type="button" class="btn btn-primary btn-lg w-100" onclick="payWithPaystack('card')">
                            <i class="fas fa-credit-card me-2"></i>Card Payment
                        </button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-success btn-lg w-100" onclick="payWithPaystack('mobile')">
                            <i class="fas fa-mobile-alt me-2"></i>Mobile Money
                        </button>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt me-1"></i>
                        Secure payment powered by Paystack
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://js.paystack.co/v1/inline.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Render usage chart if data is available
{% if monthly_usage %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('usageChart').getContext('2d');
    const monthlyData = {{ monthly_usage|safe }};

    const labels = monthlyData.map(item => {
        const date = new Date(item.month);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
    });

    const sentData = monthlyData.map(item => item.sent_count);
    const costData = monthlyData.map(item => parseFloat(item.total_cost || 0));

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'SMS Sent',
                data: sentData,
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                yAxisID: 'y',
                tension: 0.4,
                fill: true
            }, {
                label: 'Cost (₵)',
                data: costData,
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                yAxisID: 'y1',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return context.dataset.label + ': ' + context.parsed.y + ' SMS';
                            } else {
                                return context.dataset.label + ': ₵' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'SMS Count'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Cost (₵)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            }
        }
    });
});
{% endif %}
<script>
function showPaymentModal() {
    const amountInput = document.getElementById('amount');
    const amount = parseFloat(amountInput.value);

    if (!amount || amount < {{ min_payment_amount }}) {
        alert('Please enter a valid amount (minimum ₵{{ min_payment_amount }}).');
        amountInput.focus();
        return;
    }

    if (amount > {{ max_payment_amount }}) {
        alert('Amount cannot exceed ₵{{ max_payment_amount|floatformat:0 }}.');
        amountInput.focus();
        return;
    }

    // Update modal amount display
    document.getElementById('modalAmount').textContent = '₵' + amount.toFixed(2);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

function payWithPaystack(method) {
    console.log('Starting Paystack payment process...');
    const amountInput = document.getElementById('amount');
    const amount = parseFloat(amountInput.value);

    console.log('Amount:', amount, 'Method:', method);

    // Validate amount
    if (isNaN(amount) || amount < {{ min_payment_amount }}) { // Minimum {{ min_payment_amount }} GHS
        alert('Please enter a valid amount (minimum ₵{{ min_payment_amount }})');
        return;
    }

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
    modal.hide();

    // Show loading overlay
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'payment-loading-overlay';
    loadingOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 123, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
    `;
    loadingOverlay.innerHTML = `
        <div class="text-center">
            <div class="spinner-border spinner-border-lg mb-3" role="status">
                <span class="visually-hidden">Initializing payment...</span>
            </div>
            <h5>Initializing payment...</h5>
            <p class="text-white-50">Please wait</p>
        </div>
    `;
    document.body.appendChild(loadingOverlay);

    // First, initialize payment on server
    fetch('{% url "org_billing_initialize_payment" organization.slug %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            'amount': amount.toFixed(2)
        })
    })
    .then(response => response.json())
    .then(initData => {
        if (!initData.success) {
            throw new Error(initData.message || 'Failed to initialize payment');
        }

        console.log('Payment initialized:', initData);
        
        // Update loading message
        loadingOverlay.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-lg mb-3" role="status">
                    <span class="visually-hidden">Processing payment...</span>
                </div>
                <h5>Processing your payment...</h5>
                <p class="text-white-50">Please do not close this window</p>
            </div>
        `;

        // Initialize Paystack payment with server-generated reference
        console.log('Setting up Paystack handler...');
        const handler = PaystackPop.setup({
            key: '{{ paystack_public_key }}',
            email: '{{ user.email }}',
            amount: amount * 100, // Convert to pesewas
            currency: 'GHS',
            ref: initData.reference,
            metadata: {
                organization_id: '{{ organization.id }}',
                organization_slug: '{{ organization.slug }}',
                payment_type: 'balance_topup',
                payment_method: method
            },
            callback: function(response) {
                console.log('Paystack callback received:', response);
                // Remove loading overlay
                const overlay = document.getElementById('payment-loading-overlay');
                if (overlay) overlay.remove();

                // Submit payment verification to server
                fetch('{% url "org_billing_callback" organization.slug %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: new URLSearchParams({
                        'reference': response.reference
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        const successAlert = document.createElement('div');
                        successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                        successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        successAlert.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>Payment successful! Balance updated.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(successAlert);

                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        alert('Payment verification failed: ' + data.message);
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Payment verification error:', error);
                    alert('Error verifying payment. Please contact support with reference: ' + response.reference);
                    location.reload();
                });
            },
            onClose: function() {
                console.log('Paystack popup closed by user');
                // Remove loading overlay
                const overlay = document.getElementById('payment-loading-overlay');
                if (overlay) overlay.remove();
                alert('Payment cancelled.');
            }
        });

        // Check if Paystack key is available
        {% if not paystack_public_key %}
            const overlay = document.getElementById('payment-loading-overlay');
            if (overlay) overlay.remove();
            alert('Payment system is not configured. Please contact support.');
            return;
        {% endif %}

        // Check if PaystackPop is available
        if (typeof PaystackPop === 'undefined') {
            const overlay = document.getElementById('payment-loading-overlay');
            if (overlay) overlay.remove();
            alert('Payment system failed to load. Please refresh the page and try again.');
            return;
        }

        try {
            handler.openIframe();
        } catch (error) {
            console.error('Paystack error:', error);
            const overlay = document.getElementById('payment-loading-overlay');
            if (overlay) overlay.remove();
            alert('Failed to initialize payment. Please try again.');
        }
    })
    .catch(error => {
        console.error('Payment initialization error:', error);
        const overlay = document.getElementById('payment-loading-overlay');
        if (overlay) overlay.remove();
        alert('Failed to initialize payment: ' + error.message);
    });
}

// Enable/disable button based on amount input
document.getElementById('amount').addEventListener('input', function() {
    const amount = parseFloat(this.value);
    const btn = document.getElementById('addBalanceBtn');
    const isValid = amount && amount >= {{ min_payment_amount }} && amount <= {{ max_payment_amount }};
    btn.disabled = !isValid;
});

// Quick amount setter
function setAmount(amount) {
    document.getElementById('amount').value = amount.toFixed(2);
    // Trigger input event to enable/disable button
    document.getElementById('amount').dispatchEvent(new Event('input'));
}

// Initialize button state
document.addEventListener('DOMContentLoaded', function() {
    const amountInput = document.getElementById('amount');
    const btn = document.getElementById('addBalanceBtn');
    const amount = parseFloat(amountInput.value);
    const isValid = amount && amount >= {{ min_payment_amount }} && amount <= {{ max_payment_amount }};
    btn.disabled = !isValid;
});
</script>

<style>
/* Mobile-specific styles for billing page */
@media (max-width: 768px) {
    /* Adjust container padding for mobile */
    .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
    }

    /* Make cards more mobile-friendly */
    .card {
        margin-bottom: 1rem;
        border-radius: 12px;
    }

    .card-body {
        padding: 1.5rem 1rem;
    }

    /* Better button sizing */
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }

    /* Form improvements */
    .form-control-lg {
        font-size: 1rem;
        padding: 0.75rem;
    }

    /* Modal improvements for mobile */
    .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100vw - 1rem);
    }

    .modal-content {
        border-radius: 12px;
    }

    /* Payment method buttons */
    .btn-success, .btn-primary {
        margin-bottom: 0.5rem;
        padding: 0.75rem;
        font-size: 1rem;
    }

    /* Amount display */
    #modalAmount {
        font-size: 1.5rem;
    }

    /* Balance display */
    .display-4 {
        font-size: 2rem;
    }

    /* Metric cards */
    .metric-card .metric-value {
        font-size: 1.75rem;
    }

    /* Table responsiveness */
    .table-responsive {
        font-size: 0.875rem;
    }

    .table td, .table th {
        padding: 0.5rem;
    }
}

/* Loading overlay for payments */
#payment-loading-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 123, 255, 0.95) !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    z-index: 9999 !important;
    color: white !important;
}

#payment-loading-overlay .text-center {
    max-width: 90vw;
}
</style>
{% endblock %}