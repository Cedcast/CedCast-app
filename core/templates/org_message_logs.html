{% extends "base.html" %}
{% load static %}

{% block title %}{{ organization.name }} - Message Logs{% endblock %}

{% block content %}
{% include "org_admin_combined_nav.html" %}

<div class="container-fluid py-4 org-admin-page">
    <div class="container">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="mb-2 text-primary fw-bold">
                            <i class="fas fa-history me-3"></i>Message Logs
                        </h1>
                        <p class="text-muted mb-0">Track and monitor all your sent messages</p>
                    </div>
                    <div class="text-end">
                        <div class="d-flex align-items-center">
                            <div class="badge bg-primary me-3 px-3 py-2">
                                <i class="fas fa-envelope me-1"></i>{{ logs|length }} Messages
                            </div>
                            <div class="stats-grid d-flex gap-2">
                                {% with sent_count=logs|length %}
                                {% if sent_count > 0 %}
                                <div class="badge bg-success px-2 py-1">
                                    <i class="fas fa-check me-1"></i>{{ logs|length }}
                                </div>
                                {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filters & Search
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="get" id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label fw-semibold">
                            <i class="fas fa-info-circle me-2"></i>Status
                        </label>
                        <select id="statusFilter" name="status" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="sent" {% if status == 'sent' %}selected{% endif %}>Sent</option>
                            <option value="failed" {% if status == 'failed' %}selected{% endif %}>Failed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="fromDate" class="form-label fw-semibold">
                            <i class="fas fa-calendar-alt me-2"></i>From Date
                        </label>
                        <input type="date" id="fromDate" name="from" class="form-control" value="{{ from }}">
                    </div>
                    <div class="col-md-3">
                        <label for="toDate" class="form-label fw-semibold">
                            <i class="fas fa-calendar-alt me-2"></i>To Date
                        </label>
                        <input type="date" id="toDate" name="to" class="form-control" value="{{ to }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-search me-2"></i>Actions
                        </label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-fill">
                                <i class="fas fa-filter me-2"></i>Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Message Logs Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Message History
                </h5>
            </div>
            <div class="card-body p-0">
                {% if logs %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="border-0 px-4 py-3 fw-semibold">
                                    <i class="fas fa-user me-2"></i>Contact
                                </th>
                                <th class="border-0 px-4 py-3 fw-semibold">
                                    <i class="fas fa-phone me-2"></i>Phone
                                </th>
                                <th class="border-0 px-4 py-3 fw-semibold">
                                    <i class="fas fa-comment me-2"></i>Message
                                </th>
                                <th class="border-0 px-4 py-3 fw-semibold">
                                    <i class="fas fa-info-circle me-2"></i>Status
                                </th>
                                <th class="border-0 px-4 py-3 fw-semibold">
                                    <i class="fas fa-clock me-2"></i>Sent At
                                </th>
                                <th class="border-0 px-4 py-3 fw-semibold">
                                    <i class="fas fa-cogs me-2"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for l in logs %}
                            <tr>
                                <td class="px-4 py-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 avatar-circle">
                                            {{ l.contact.name|first|upper }}
                                        </div>
                                        <div>
                                            <div class="fw-semibold">{{ l.contact.name }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="font-monospace">{{ l.contact.phone_number }}</span>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="message-preview">
                                        <span class="text-truncate d-inline-block w-100" title="{{ l.message.content }}">
                                            {{ l.message.content|truncatechars:50 }}
                                        </span>
                                        {% if l.message.content|length > 50 %}
                                        <button class="btn btn-sm btn-link p-0 ms-1" onclick="showFullMessage('{{ l.message.content|escapejs }}', '{{ l.contact.name }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    {% if l.status == 'sent' %}
                                    <span class="badge bg-success px-3 py-2">
                                        <i class="fas fa-check me-1"></i>Sent
                                    </span>
                                    {% elif l.status == 'pending' %}
                                    <span class="badge bg-warning px-3 py-2">
                                        <i class="fas fa-clock me-1"></i>Pending
                                    </span>
                                    {% elif l.status == 'failed' %}
                                    <span class="badge bg-danger px-3 py-2">
                                        <i class="fas fa-times me-1"></i>Failed
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary px-3 py-2">
                                        <i class="fas fa-question me-1"></i>{{ l.status|title }}
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3">
                                    {% if l.sent_at %}
                                    <div>
                                        <div class="fw-semibold">{{ l.sent_at|date:'M j, Y' }}</div>
                                        <small class="text-muted">{{ l.sent_at|date:'H:i' }}</small>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">â€”</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-primary btn-sm"
                                                onclick="viewMessageDetails({{ l.id }}, '{{ l.contact.name }}', '{{ l.contact.phone_number }}', '{{ l.message.content|escapejs }}', '{{ l.status }}', '{% if l.sent_at %}{{ l.sent_at|date:'M j, Y H:i' }}{% else %}''{% endif %}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <form method="post" class="d-inline" onsubmit="return confirmDelete('{{ l.contact.name }}')">
                                            {% csrf_token %}
                                            <input type="hidden" name="log_id" value="{{ l.id }}">
                                            <button type="submit" name="delete_log" class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="display-1 text-muted mb-3">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h5 class="text-muted mb-3">No Message Logs Yet</h5>
                    <p class="text-muted">Your sent messages will appear here once you start sending communications</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Message Details Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary">
                    <i class="fas fa-envelope me-2"></i>Message Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <label class="text-muted small mb-1">Contact Name</label>
                            <div class="fw-semibold" id="modalContactName"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <label class="text-muted small mb-1">Phone Number</label>
                            <div class="font-monospace" id="modalPhoneNumber"></div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="p-3 bg-light rounded">
                            <label class="text-muted small mb-1">Message Content</label>
                            <div class="mt-2 p-3 bg-white border rounded" id="modalMessageContent"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <label class="text-muted small mb-1">Status</label>
                            <div class="mt-2" id="modalStatus"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <label class="text-muted small mb-1">Sent At</label>
                            <div class="fw-semibold mt-2" id="modalSentAt"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Full Message Modal -->
<div class="modal fade" id="fullMessageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary">
                    <i class="fas fa-comment me-2"></i>Full Message
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <strong id="fullMessageContact"></strong>
                </div>
                <div class="p-3 bg-light rounded message-content" id="fullMessageContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    document.getElementById('filterForm').submit();
}

function viewMessageDetails(id, contactName, phoneNumber, messageContent, status, sentAt) {
    document.getElementById('modalContactName').textContent = contactName;
    document.getElementById('modalPhoneNumber').textContent = phoneNumber;
    document.getElementById('modalMessageContent').textContent = messageContent;
    document.getElementById('modalSentAt').textContent = sentAt || 'Not sent yet';

    const statusElement = document.getElementById('modalStatus');
    let statusHtml = '';

    if (status === 'sent') {
        statusHtml = '<span class="badge bg-success px-3 py-2"><i class="fas fa-check me-1"></i>Sent</span>';
    } else if (status === 'pending') {
        statusHtml = '<span class="badge bg-warning px-3 py-2"><i class="fas fa-clock me-1"></i>Pending</span>';
    } else if (status === 'failed') {
        statusHtml = '<span class="badge bg-danger px-3 py-2"><i class="fas fa-times me-1"></i>Failed</span>';
    } else {
        statusHtml = '<span class="badge bg-secondary px-3 py-2"><i class="fas fa-question me-1"></i>' + status.charAt(0).toUpperCase() + status.slice(1) + '</span>';
    }

    statusElement.innerHTML = statusHtml;

    new bootstrap.Modal(document.getElementById('messageModal')).show();
}

function showFullMessage(content, contactName) {
    document.getElementById('fullMessageContact').textContent = 'Message to ' + contactName;
    document.getElementById('fullMessageContent').textContent = content;
    new bootstrap.Modal(document.getElementById('fullMessageModal')).show();
}

function confirmDelete(contactName) {
    return confirm('Are you sure you want to delete the message log for ' + contactName + '? This action cannot be undone.');
}

// Auto-submit form when filters change
document.getElementById('statusFilter').addEventListener('change', function() {
    document.getElementById('filterForm').submit();
});

// Add loading state to filter button
document.getElementById('filterForm').addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Filtering...';
    submitBtn.disabled = true;

    // Re-enable after a delay (in case of client-side validation failure)
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 2000);
});
</script>
{% endblock %}
