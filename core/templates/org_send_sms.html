{% extends 'base.html' %}
{% load static %}
{% block title %}{{ organization.name }} - Send Messages{% endblock %}

{% block content %}
{% include 'org_admin_nav.html' %}
{% include 'org_admin_horizontal_nav.html' %}

<div class="container-fluid py-4 org-admin-page">
    <div class="container">

        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="mb-2 text-primary fw-bold">
                            <i class="fas fa-paper-plane me-3"></i>Send Messages
                        </h1>
                        <p class="text-muted mb-0">Compose and send SMS messages to your contacts and groups</p>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-primary px-3 py-2">
                            <i class="fas fa-building me-1"></i>{{ organization.name }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if error %}
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        {% if success %}
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-check-circle me-2"></i>{{ success }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-edit me-2"></i>Compose Message
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <form method="post">
                            {% csrf_token %}

                            <!-- Template Selection -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold text-primary">
                                    <i class="fas fa-file-text me-2"></i>Choose a Template (Optional)
                                </label>
                                <select name="template_id" id="template_id" class="form-select form-select-lg">
                                    <option value="">-- Start with a blank message --</option>
                                    {% for t in templates %}
                                        <option value="{{ t.id }}" data-content="{{ t.content|escape }}">{{ t.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select a saved template or compose a custom message below</div>
                            </div>

                            <!-- Message Content -->
                            <div class="mb-4">
                                <label for="message_body" class="form-label fw-semibold text-primary">
                                    <i class="fas fa-comment me-2"></i>Message Content
                                </label>
                                <textarea name="sms_body" id="message_body" class="form-control" rows="6" placeholder="Type your message here..." required></textarea>
                                <div class="form-text">
                                    <span id="charCount">0</span> characters (<span id="smsCount">1</span> SMS)
                                </div>
                            </div>

                            <!-- Recipients -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold text-primary">
                                    <i class="fas fa-users me-2"></i>Recipients
                                </label>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="recipient_type" id="all_contacts" value="all" checked>
                                            <label class="form-check-label" for="all_contacts">
                                                All Contacts ({{ contacts|length }})
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="recipient_type" id="select_groups" value="groups">
                                            <label class="form-check-label" for="select_groups">
                                                Select Groups
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Groups Selection -->
                                <div id="groups_section" class="mt-3" style="display: none;">
                                    <div class="border rounded p-3 bg-light">
                                        <div class="row g-2">
                                            {% for group in groups %}
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="groups" value="{{ group.id }}" id="group_{{ group.id }}">
                                                    <label class="form-check-label" for="group_{{ group.id }}">
                                                        {{ group.name }} ({{ group.contacts.count }})
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Schedule Options -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold text-primary">
                                    <i class="fas fa-clock me-2"></i>Send Options
                                </label>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="send_type" id="send_now" value="now" checked>
                                            <label class="form-check-label" for="send_now">
                                                Send Now
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="send_type" id="schedule_later" value="schedule">
                                            <label class="form-check-label" for="schedule_later">
                                                Schedule for Later
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Schedule Date/Time -->
                                <div id="schedule_section" class="mt-3" style="display: none;">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="scheduled_date" class="form-label">Date</label>
                                            <input type="date" class="form-control" id="scheduled_date" name="scheduled_date">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="scheduled_time" class="form-label">Time</label>
                                            <input type="time" class="form-control" id="scheduled_time" name="scheduled_time">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-3">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i>Send Message
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="previewMessage()">
                                    <i class="fas fa-eye me-2"></i>Preview
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Balance Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-wallet me-2"></i>Account Balance
                        </h6>
                    </div>
                    <div class="card-body text-center">
                        <div class="display-6 fw-bold text-success mb-2">₵{{ organization.balance|floatformat:2 }}</div>
                        <p class="text-muted mb-0">Available SMS credits</p>
                    </div>
                </div>

                <!-- Message Preview -->
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-eye me-2"></i>Message Preview
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="message_preview" class="p-3 bg-light rounded small">
                            Your message will appear here...
                        </div>
                        <div class="mt-3 text-muted small">
                            <div id="preview_stats">
                                Recipients: <span id="preview_recipients">0</span><br>
                                Estimated cost: ₵<span id="preview_cost">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateSelect = document.getElementById('template_id');
    const messageTextarea = document.getElementById('message_body');
    const charCount = document.getElementById('charCount');
    const smsCount = document.getElementById('smsCount');

    // Template selection
    templateSelect.addEventListener('change', function() {
        if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            const templateContent = selectedOption.getAttribute('data-content');
            if (templateContent) {
                messageTextarea.value = templateContent;
                updateCounts();
            }
        }
    });

    // Character/SMS counting
    messageTextarea.addEventListener('input', updateCounts);

    function updateCounts() {
        const text = messageTextarea.value;
        const chars = text.length;
        charCount.textContent = chars;

        // Simple SMS counting (160 chars per SMS)
        const sms = Math.ceil(chars / 160) || 1;
        smsCount.textContent = sms;
    }

    // Recipient type selection
    document.querySelectorAll('input[name="recipient_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const groupsSection = document.getElementById('groups_section');
            groupsSection.style.display = this.value === 'groups' ? 'block' : 'none';
        });
    });

    // Send type selection
    document.querySelectorAll('input[name="send_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const scheduleSection = document.getElementById('schedule_section');
            scheduleSection.style.display = this.value === 'schedule' ? 'block' : 'none';
        });
    });

    // Preview message
    window.previewMessage = function() {
        const message = messageTextarea.value;
        const preview = document.getElementById('message_preview');
        preview.textContent = message || 'Your message will appear here...';
    };

    // Initialize counts
    updateCounts();
});
</script>
{% endblock %}
