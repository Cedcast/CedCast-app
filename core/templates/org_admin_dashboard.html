{% extends 'base.html' %}
{% block title %}{{ organization.name }} - Admin Dashboard{% endblock %}
{% block body_class %}oid-dashboard{% endblock %}
{% block content %}
    {% include 'org_admin_combined_nav.html' %}

    <div class="container-fluid py-4">
        {% if hubtel_dry_run or clicksend_dry_run %}
        <div class="mb-3">
            <div class="alert alert-warning">
                <strong>Test mode:</strong>
                {% if hubtel_dry_run %} Hubtel is in dry-run mode ‚Äî messages will not be sent.{% endif %}
                {% if clicksend_dry_run %} {% if hubtel_dry_run %}<br>{% endif %} ClickSend is in dry-run mode ‚Äî messages will not be sent.{% endif %}
            </div>
        </div>
        {% endif %}
        {% if is_suspended %}
        <div class="mb-3">
            <div class="alert alert-danger">
                <strong>Account Suspended:</strong> Your organization account has been suspended. You cannot send messages or add contacts. Please contact support for assistance.
            </div>
        </div>
        {% endif %}
        {% if low_balance %}
        <div class="mb-3">
            <div class="alert alert-warning">
                <strong>Low SMS:</strong> Your SMS balance is low ({{ organization.sms_remaining }} SMS remaining). Please <a href="{% url 'org_billing' organization.slug %}">purchase more SMS</a> to continue sending messages.
            </div>
        </div>
        {% endif %}
        {% if critical_balance %}
        <div class="mb-3">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Critical Balance Alert!</strong> Your account balance is below ‚Çµ5.00 (Current: ‚Çµ{{ organization.balance|floatformat:2 }}). 
                <a href="{% url 'org_billing' organization.slug %}" class="alert-link">Click here to top up</a> immediately to avoid service interruption.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
        {% endif %}

        <!-- Main Content Area -->
        <div class="row">
            <div class="col-12">
                <div class="row mb-3">
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-people me-1"></i> Contacts</h6>
                                <h3 class="card-title"><i class="bi bi-people-fill stat-emoji"></i> {{ contacts_count|default:0 }}</h3>
                                <canvas id="spark_contacts" width="120" height="32" data-trend='{{ contacts_trend|default:"[]"|escapejs }}'></canvas>
                                <a href="{% url 'org_upload_contacts' organization.slug %}" class="stretched-link" aria-label="Open contacts"></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-folder me-1"></i> Templates</h6>
                                <h3 class="card-title"><i class="bi bi-folder-fill stat-emoji"></i> {{ templates_count|default:0 }}</h3>
                                <canvas id="spark_templates" width="120" height="32" data-trend='{{ templates_trend|default:"[]"|escapejs }}'></canvas>
                                <a href="{% url 'org_templates' organization.slug %}" class="stretched-link" aria-label="Open templates"></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-send me-1"></i> Sent Today</h6>
                                <h3 class="card-title"><i class="bi bi-send-fill stat-emoji"></i> {{ msgs_sent_today|default:0 }}</h3>
                                <canvas id="spark_sent" width="120" height="32" data-trend='{{ msgs_sent_trend|default:"[]"|escapejs }}'></canvas>
                                <a href="{% url 'org_sent_messages' organization.slug %}" class="stretched-link" aria-label="Open sent messages"></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-graph-up me-1"></i> Delivery Rate</h6>
                                <h3 class="card-title"><i class="bi bi-patch-check-fill stat-emoji"></i> {{ delivery_rate|floatformat:1 }}%</h3>
                                <div class="progress mt-2" style="height:10px; border-radius:8px; background:#eef2f6;">
                                    {% with rate=delivery_rate|default:0 %}
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ rate }}%;" aria-valuenow="{{ rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    {% endwith %}
                                </div>
                                <canvas id="spark_delivery" width="120" height="24" data-trend='{{ delivery_trend|default:"[]"|escapejs }}'></canvas>
                                <a href="{% url 'org_message_logs' organization.slug %}" class="stretched-link" aria-label="Open message logs"></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-chat-dots me-1"></i> SMS Balance</h6>
                                <h3 class="card-title"><i class="bi bi-chat-dots stat-emoji"></i> {{ organization.sms_remaining }}</h3>
                                <p class="text-muted small mb-0">SMS remaining</p>
                                <a href="{% url 'org_billing' organization.slug %}" class="stretched-link" aria-label="Manage billing"></a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6 mb-2">
                        <div class="card shadow-sm">
                                <div class="card-header bg-secondary text-white">Quick Actions ‚ö°</div>
                            <div class="card-body">
                                <a href="{% url 'org_upload_contacts' organization.slug %}" class="btn btn-sm btn-outline-primary me-2">üì• Upload</a>
                                <a href="{% url 'org_templates' organization.slug %}" class="btn btn-sm btn-outline-secondary me-2">üóÇÔ∏è Templates</a>
                                <a href="{% url 'org_retry_failed' organization.slug %}" class="btn btn-sm btn-outline-danger me-2">üîÅ Retry Failed</a>
                                <a href="{% url 'org_billing' organization.slug %}" class="btn btn-sm btn-outline-success">üí∞ Billing</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="card shadow-sm">
                                <div class="card-header bg-secondary text-white">Add Contact ‚ûï</div>
                            <div class="card-body">
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input name="contact_name" class="form-control" placeholder="Full name" />
                                        </div>
                                        <div class="col-6">
                                            <input name="contact_phone" class="form-control" placeholder="Phone (include +233)" />
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-primary btn-sm" type="submit">‚ûï Add Contact</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="card shadow-sm">
                            <div class="card-header bg-secondary text-white">Messages (Last 7 days)</div>
                            <div class="card-body">
                                <p>Sent this week: <strong>{{ msgs_sent_week|default:0 }}</strong></p>
                                <p>Sent this month: <strong>{{ msgs_sent_month|default:0 }}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                                <div class="card shadow">
                                    <div class="card-header bg-secondary text-white">Messages ‚úâÔ∏è</div>
                                    <div class="card-body text-center">
                                        <p class="mb-2">View scheduled or previously sent messages in full detail.</p>
                                        <div class="d-flex justify-content-center gap-2">
                                            <a href="{% url 'org_scheduled_messages' organization.slug %}" class="btn btn-outline-primary">‚è∞ Scheduled</a>
                                            <a href="{% url 'org_sent_messages' organization.slug %}" class="btn btn-primary">üì§ Sent</a>
                                        </div>
                                    </div>
                                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Render small sparklines for dashboard cards (Chart.js)
document.addEventListener('DOMContentLoaded', function(){
    function renderSpark(id, color){
        try{
            var el = document.getElementById(id);
            if(!el) return;
            var raw = el.getAttribute('data-trend') || '[]';
            var data = [];
            try{ data = JSON.parse(raw); }catch(e){
                // fallback: if empty, try to read a single number from text
                var n = parseInt(el.textContent||'',10); if(!isNaN(n)) data=[n];
            }
            if(!data || !data.length) data = [0,0,0,0,0];
            var ctx = el.getContext('2d');
            // small chart, minimal UI
            new Chart(ctx, {
                type: 'line',
                data: { labels: data.map((_,i)=>i+1), datasets: [{ data: data, borderColor: color, backgroundColor: 'transparent', tension:0.3, pointRadius:0 }] },
                options: { responsive:false, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, elements:{line:{borderWidth:2}} }
            });
        }catch(err){ console.error('spark error', err); }
    }

    renderSpark('spark_contacts', '#0d6efd');
    renderSpark('spark_templates', '#6c757d');
    renderSpark('spark_sent', '#0dcaf0');
    renderSpark('spark_delivery', '#28a745');

    // Critical balance popup notification
    {% if critical_balance %}
    setTimeout(function() {
        const balanceModal = new bootstrap.Modal(document.getElementById('criticalBalanceModal'), {
            backdrop: 'static',
            keyboard: false
        });
        balanceModal.show();
    }, 2000); // Show after 2 seconds
    {% endif %}
});
</script>

<!-- Critical Balance Modal -->
<div class="modal fade" id="criticalBalanceModal" tabindex="-1" aria-labelledby="criticalBalanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="criticalBalanceModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>Critical Balance Alert
        </h5>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <i class="bi bi-cash-coin text-danger" style="font-size: 4rem;"></i>
        </div>
        <h5 class="text-center mb-3">Your Account Balance is Critically Low!</h5>
        <div class="alert alert-danger">
          <strong>Current Balance:</strong> ‚Çµ{{ organization.balance|floatformat:2 }}<br>
          <strong>Minimum Required:</strong> ‚Çµ5.00
        </div>
        <p class="mb-0">Your SMS service may be interrupted if you don't top up immediately. Add funds now to ensure uninterrupted service.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Remind Me Later</button>
        <a href="{% url 'org_billing' organization.slug %}" class="btn btn-danger">
          <i class="bi bi-plus-circle me-1"></i>Add Balance Now
        </a>
      </div>
    </div>
  </div>
</div>

{% endblock %}
