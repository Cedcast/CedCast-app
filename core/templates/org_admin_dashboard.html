{% extends 'base.html' %}
{% block title %}{{ organization.name }} - Admin Dashboard{% endblock %}
{% block body_class %}oid-dashboard{% endblock %}
{% block content %}
    <nav class="navbar navbar-expand-lg" style="background: {{ organization.primary_color }};">
        <div class="container-fluid">
            <a class="navbar-brand text-white d-flex align-items-center gap-2" href="#"><i class="bi bi-building-fill" aria-hidden="true"></i> <span class="brand-name">{{ organization.name }}</span>
                {% if organization.is_premium %}<span class="badge bg-warning text-dark ms-2">PREMIUM</span>{% endif %}
            </a>
            <div class="d-flex align-items-center gap-2">
                <div class="text-white small sender-preview d-none d-md-block">Sending as: <strong>{{ organization.sender_id|default:organization.name }}</strong></div>

                <div class="position-relative">
                    <button class="btn btn-outline-light btn-sm p-1" id="notifBtn" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-bell-fill" aria-hidden="true"></i>
                        {% if notification_count|default:0|add:0 > 0 %}
                        <span class="notif-badge">{{ notification_count }}</span>
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="notifBtn" style="min-width:220px;">
                        <li class="dropdown-header">Notifications</li>
                        {% if notifications %}
                            {% for n in notifications|slice:":5" %}
                                <li><a class="dropdown-item" href="{{ n.link|default:'#' }}">{{ n.message }}</a></li>
                            {% endfor %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-center small" href="#">View all</a></li>
                        {% else %}
                            <li class="dropdown-item small text-muted">No notifications</li>
                        {% endif %}
                    </ul>
                </div>

                <div class="dropdown">
                    <a class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" href="#" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="avatar bg-light text-dark me-2">{{ user.username|default:user.email|slice:":1"|upper }}</div>
                        <span class="d-none d-sm-inline">{{ user.get_full_name|default:user.username }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="/profile/">Profile</a></li>
                        <li><a class="dropdown-item" href="{% url 'org_billing' organization.slug %}">Billing</a></li>
                        <li><a class="dropdown-item" href="#">Switch organisation</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout/">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        {% if hubtel_dry_run or clicksend_dry_run %}
        <div class="mb-3">
            <div class="alert alert-warning">
                <strong>Test mode:</strong>
                {% if hubtel_dry_run %} Hubtel is in dry-run mode ‚Äî messages will not be sent.{% endif %}
                {% if clicksend_dry_run %} {% if hubtel_dry_run %}<br>{% endif %} ClickSend is in dry-run mode ‚Äî messages will not be sent.{% endif %}
            </div>
        </div>
        {% endif %}
        {% if is_suspended %}
        <div class="mb-3">
            <div class="alert alert-danger">
                <strong>Account Suspended:</strong> Your organization account has been suspended. You cannot send messages or add contacts. Please contact support for assistance.
            </div>
        </div>
        {% endif %}
        {% if low_balance %}
        <div class="mb-3">
            <div class="alert alert-warning">
                <strong>Low SMS:</strong> Your SMS balance is low ({{ organization.sms_remaining }} SMS remaining). Please <a href="{% url 'org_billing' organization.slug %}">purchase more SMS</a> to continue sending messages.
            </div>
        </div>
        {% endif %}
        <div class="row">
                    <div class="col-md-3 mb-3" id="sidebarCol">
                        <div class="card shadow-sm sidebar-card">
                            <div class="card-body p-2 sidebar" id="sidebar">
                                <div class="d-flex align-items-center mb-2 gap-2">
                                    <input id="sidebarSearch" class="form-control form-control-sm" placeholder="Search..." aria-label="Search sidebar">
                                    <button id="sidebarToggle" class="btn btn-sm btn-outline-secondary" title="Collapse sidebar"><i class="bi bi-chevron-left"></i></button>
                                </div>
                                <h5 class="card-title visually-hidden">{{ organization.name }}</h5>
                                <div class="list-group list-group-flush" id="sidebarList">
                                    <a href="{% url 'org_dashboard' organization.slug %}" class="list-group-item list-group-item-action"><i class="bi bi-speedometer2 me-2"></i><span class="label">Dashboard</span></a>
                                    <a href="{% url 'org_send_sms' organization.slug %}" class="list-group-item list-group-item-action"><i class="bi bi-send-fill me-2"></i><span class="label">Send Messages</span></a>
                                    <a href="{% url 'org_upload_contacts' organization.slug %}" class="list-group-item list-group-item-action"><i class="bi bi-person-lines-fill me-2"></i><span class="label">Contacts</span></a>
                                    <a href="{% url 'org_groups' organization.slug %}" class="list-group-item list-group-item-action"><i class="bi bi-people-fill me-2"></i><span class="label">Groups</span></a>
                                    <a href="{% url 'org_templates' organization.slug %}" class="list-group-item list-group-item-action"><i class="bi bi-folder-fill me-2"></i><span class="label">Templates</span></a>
                                    <a href="{% url 'org_message_logs' organization.slug %}" class="list-group-item list-group-item-action"><i class="bi bi-journal-text me-2"></i><span class="label">Message Logs</span></a>
                                    {% if user.is_superuser or user.is_staff or user.role == 'org_admin' or user.role == 'owner' %}
                                        <a href="{% url 'org_settings' organization.slug %}" class="list-group-item list-group-item-action"><i class="bi bi-gear-fill me-2"></i><span class="label">Settings</span></a>
                                        <a href="{% url 'org_billing' organization.slug %}" class="list-group-item list-group-item-action"><i class="bi bi-cash-stack me-2"></i><span class="label">Billing</span></a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

            <div class="col-md-9">
                <div class="row mb-3">
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-people me-1"></i> Contacts</h6>
                                <h3 class="card-title"><i class="bi bi-people-fill stat-emoji"></i> {{ contacts_count|default:0 }}</h3>
                                <canvas id="spark_contacts" width="120" height="32" data-trend='{{ contacts_trend|default:"[]"|escapejs }}'></canvas>
                                <a href="{% url 'org_upload_contacts' organization.slug %}" class="stretched-link" aria-label="Open contacts"></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-folder me-1"></i> Templates</h6>
                                <h3 class="card-title"><i class="bi bi-folder-fill stat-emoji"></i> {{ templates_count|default:0 }}</h3>
                                <canvas id="spark_templates" width="120" height="32" data-trend='{{ templates_trend|default:"[]"|escapejs }}'></canvas>
                                <a href="{% url 'org_templates' organization.slug %}" class="stretched-link" aria-label="Open templates"></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-send me-1"></i> Sent Today</h6>
                                <h3 class="card-title"><i class="bi bi-send-fill stat-emoji"></i> {{ msgs_sent_today|default:0 }}</h3>
                                <canvas id="spark_sent" width="120" height="32" data-trend='{{ msgs_sent_trend|default:"[]"|escapejs }}'></canvas>
                                <a href="{% url 'org_sent_messages' organization.slug %}" class="stretched-link" aria-label="Open sent messages"></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-graph-up me-1"></i> Delivery Rate</h6>
                                <h3 class="card-title"><i class="bi bi-patch-check-fill stat-emoji"></i> {{ delivery_rate|floatformat:1 }}%</h3>
                                <div class="progress mt-2" style="height:10px; border-radius:8px; background:#eef2f6;">
                                    {% with rate=delivery_rate|default:0 %}
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ rate }}%;" aria-valuenow="{{ rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    {% endwith %}
                                </div>
                                <canvas id="spark_delivery" width="120" height="24" data-trend='{{ delivery_trend|default:"[]"|escapejs }}'></canvas>
                                <a href="{% url 'org_message_logs' organization.slug %}" class="stretched-link" aria-label="Open message logs"></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2">
                        <div class="card text-center shadow-sm position-relative" style="overflow:visible;">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted"><i class="bi bi-chat-dots me-1"></i> SMS Balance</h6>
                                <h3 class="card-title"><i class="bi bi-chat-dots stat-emoji"></i> {{ organization.sms_remaining }}</h3>
                                <p class="text-muted small mb-0">SMS remaining</p>
                                <a href="{% url 'org_billing' organization.slug %}" class="stretched-link" aria-label="Manage billing"></a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6 mb-2">
                        <div class="card shadow-sm">
                                <div class="card-header bg-secondary text-white">Quick Actions ‚ö°</div>
                            <div class="card-body">
                                <a href="{% url 'org_upload_contacts' organization.slug %}" class="btn btn-sm btn-outline-primary me-2">üì• Upload</a>
                                <a href="{% url 'org_templates' organization.slug %}" class="btn btn-sm btn-outline-secondary me-2">üóÇÔ∏è Templates</a>
                                <a href="{% url 'org_retry_failed' organization.slug %}" class="btn btn-sm btn-outline-danger me-2">üîÅ Retry Failed</a>
                                <a href="{% url 'org_billing' organization.slug %}" class="btn btn-sm btn-outline-success">üí∞ Billing</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="card shadow-sm">
                                <div class="card-header bg-secondary text-white">Add Contact ‚ûï</div>
                            <div class="card-body">
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input name="contact_name" class="form-control" placeholder="Full name" />
                                        </div>
                                        <div class="col-6">
                                            <input name="contact_phone" class="form-control" placeholder="Phone (include +233)" />
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-primary btn-sm" type="submit">‚ûï Add Contact</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="card shadow-sm">
                            <div class="card-header bg-secondary text-white">Messages (Last 7 days)</div>
                            <div class="card-body">
                                <p>Sent this week: <strong>{{ msgs_sent_week|default:0 }}</strong></p>
                                <p>Sent this month: <strong>{{ msgs_sent_month|default:0 }}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                                <div class="card shadow">
                                    <div class="card-header bg-secondary text-white">Messages ‚úâÔ∏è</div>
                                    <div class="card-body text-center">
                                        <p class="mb-2">View scheduled or previously sent messages in full detail.</p>
                                        <div class="d-flex justify-content-center gap-2">
                                            <a href="{% url 'org_scheduled_messages' organization.slug %}" class="btn btn-outline-primary">‚è∞ Scheduled</a>
                                            <a href="{% url 'org_sent_messages' organization.slug %}" class="btn btn-primary">üì§ Sent</a>
                                        </div>
                                    </div>
                                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_scripts %}
<script>
// Sidebar search and collapse behavior
document.addEventListener('DOMContentLoaded', function () {
    var search = document.getElementById('sidebarSearch');
    var list = document.getElementById('sidebarList');
    var toggle = document.getElementById('sidebarToggle');
    var sidebarCol = document.getElementById('sidebarCol');

    if (search) {
        search.addEventListener('input', function (e) {
            var q = e.target.value.toLowerCase().trim();
            Array.from(list.querySelectorAll('.list-group-item')).forEach(function (item) {
                var txt = item.textContent.toLowerCase();
                item.style.display = txt.indexOf(q) !== -1 ? '' : 'none';
            });
        });
    }

    if (toggle && sidebarCol) {
        toggle.addEventListener('click', function () {
            sidebarCol.classList.toggle('sidebar-collapsed');
            var icon = toggle.querySelector('i');
            if (sidebarCol.classList.contains('sidebar-collapsed')) {
                icon.classList.remove('bi-chevron-left'); icon.classList.add('bi-chevron-right');
            } else {
                icon.classList.remove('bi-chevron-right'); icon.classList.add('bi-chevron-left');
            }
        });
    }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Render small sparklines for dashboard cards (Chart.js)
document.addEventListener('DOMContentLoaded', function(){
    function renderSpark(id, color){
        try{
            var el = document.getElementById(id);
            if(!el) return;
            var raw = el.getAttribute('data-trend') || '[]';
            var data = [];
            try{ data = JSON.parse(raw); }catch(e){
                // fallback: if empty, try to read a single number from text
                var n = parseInt(el.textContent||'',10); if(!isNaN(n)) data=[n];
            }
            if(!data || !data.length) data = [0,0,0,0,0];
            var ctx = el.getContext('2d');
            // small chart, minimal UI
            new Chart(ctx, {
                type: 'line',
                data: { labels: data.map((_,i)=>i+1), datasets: [{ data: data, borderColor: color, backgroundColor: 'transparent', tension:0.3, pointRadius:0 }] },
                options: { responsive:false, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, elements:{line:{borderWidth:2}} }
            });
        }catch(err){ console.error('spark error', err); }
    }

    renderSpark('spark_contacts', '#0d6efd');
    renderSpark('spark_templates', '#6c757d');
    renderSpark('spark_sent', '#0dcaf0');
    renderSpark('spark_delivery', '#28a745');
});
</script>
{% endblock %}
